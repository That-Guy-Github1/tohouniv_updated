#gold
#power
th_update_gain_modifier = {
	set_variable = {
		which = th_danmaku_$type$_gain_show
		which = th_danmaku_$type$_gain
	}
	multiply_variable = {
		which = th_danmaku_$type$_gain_show
		value = 100
	}
}


th_set_danmaku_ruler = {
	th_set_default_danmaku_stats = yes
	th_set_danmaku_ruler_$who$ = yes
	th_setup_stats_from_levels = yes
	set_ruler_flag = th_danmaku_ruler_is_set
}

th_refresh_class_and_species_stats = {
	#Class
	if = { limit = {  th_is_danmaku_class = { class = barbarian } }		th_set_danmaku_class = { class = barbarian } }
	if = { limit = {  th_is_danmaku_class = { class = warrior } }		th_set_danmaku_class = { class = warrior } }
	if = { limit = {  th_is_danmaku_class = { class = rogue } }			th_set_danmaku_class = { class = rogue } }
	if = { limit = {  th_is_danmaku_class = { class = ranger } }		th_set_danmaku_class = { class = ranger } }
	if = { limit = {  th_is_danmaku_class = { class = bard } }			th_set_danmaku_class = { class = bard } }
	if = { limit = {  th_is_danmaku_class = { class = monk } }			th_set_danmaku_class = { class = monk } }
	if = { limit = {  th_is_danmaku_class = { class = paladin } }		th_set_danmaku_class = { class = paladin } }
	if = { limit = {  th_is_danmaku_class = { class = cleric } }		th_set_danmaku_class = { class = cleric } }
	if = { limit = {  th_is_danmaku_class = { class = priest } }		th_set_danmaku_class = { class = priest } }
	if = { limit = {  th_is_danmaku_class = { class = druid } }			th_set_danmaku_class = { class = druid } }
	if = { limit = {  th_is_danmaku_class = { class = sorcerer } }		th_set_danmaku_class = { class = sorcerer } }
	if = { limit = {  th_is_danmaku_class = { class = warlock } }		th_set_danmaku_class = { class = warlock } }
	if = { limit = {  th_is_danmaku_class = { class = mage } }			th_set_danmaku_class = { class = mage } }
	if = { limit = {  th_is_danmaku_class = { class = artificer } }		th_set_danmaku_class = { class = artificer } }
	if = { limit = {  th_is_danmaku_class = { class = commoner } }		th_set_danmaku_class = { class = commoner } }
	#Species
	if = { limit = { th_is_danmaku_creature_type = { type = human } } 			th_set_danmaku_creature_type = { type = human } }
	if = { limit = { th_is_danmaku_creature_type = { type = fairy } } 			th_set_danmaku_creature_type = { type = fairy } }
	if = { limit = { th_is_danmaku_creature_type = { type = vampire } } 		th_set_danmaku_creature_type = { type = vampire } }
	if = { limit = { th_is_danmaku_creature_type = { type = god } } 			th_set_danmaku_creature_type = { type = god } }
	if = { limit = { th_is_danmaku_creature_type = { type = demigod } } 		th_set_danmaku_creature_type = { type = demigod } }
	if = { limit = { th_is_danmaku_creature_type = { type = immortal } } 		th_set_danmaku_creature_type = { type = immortal } }
	if = { limit = { th_is_danmaku_creature_type = { type = undead } } 			th_set_danmaku_creature_type = { type = undead } }
	if = { limit = { th_is_danmaku_creature_type = { type = half_phantom } } 	th_set_danmaku_creature_type = { type = half_phantom } }
	if = { limit = { th_is_danmaku_creature_type = { type = half_youkai } } 	th_set_danmaku_creature_type = { type = half_youkai } }
	if = { limit = { th_is_danmaku_creature_type = { type = youkai } } 			th_set_danmaku_creature_type = { type = youkai } }
	if = { limit = { th_is_danmaku_creature_type = { type = yama } } 			th_set_danmaku_creature_type = { type = yama } }
	if = { limit = { th_is_danmaku_creature_type = { type = hermit } } 			th_set_danmaku_creature_type = { type = hermit } }
	if = { limit = { th_is_danmaku_creature_type = { type = lunarian } } 		th_set_danmaku_creature_type = { type = lunarian } }
	if = { limit = { th_is_danmaku_creature_type = { type = oni } } 			th_set_danmaku_creature_type = { type = oni } }
	if = { limit = { th_is_danmaku_creature_type = { type = demon } } 			th_set_danmaku_creature_type = { type = demon } }
	if = { limit = { th_is_danmaku_creature_type = { type = devil } } 			th_set_danmaku_creature_type = { type = devil } }
	if = { limit = { th_is_danmaku_creature_type = { type = tengu } } 			th_set_danmaku_creature_type = { type = tengu } }
	if = { limit = { th_is_danmaku_creature_type = { type = kappa } } 			th_set_danmaku_creature_type = { type = kappa } }
	if = { limit = { th_is_danmaku_creature_type = { type = tsukumogami } } 	th_set_danmaku_creature_type = { type = tsukumogami } }
	if = { limit = { th_is_danmaku_creature_type = { type = yamanba } } 		th_set_danmaku_creature_type = { type = yamanba } }
	if = { limit = { th_is_danmaku_creature_type = { type = nue } } 			th_set_danmaku_creature_type = { type = nue } }
	if = { limit = { th_is_danmaku_creature_type = { type = satori } } 			th_set_danmaku_creature_type = { type = satori } }
	if = { limit = { th_is_danmaku_creature_type = { type = angel } } 			th_set_danmaku_creature_type = { type = angel } }
	if = { limit = { th_is_danmaku_creature_type = { type = shinigami } } 		th_set_danmaku_creature_type = { type = shinigami } }
	if = { limit = { th_is_danmaku_creature_type = { type = inchling } } 		th_set_danmaku_creature_type = { type = inchling } }
	if = { limit = { th_is_danmaku_creature_type = { type = doll } } 			th_set_danmaku_creature_type = { type = doll } }
	if = { limit = { th_is_danmaku_creature_type = { type = robot } } 			th_set_danmaku_creature_type = { type = robot } }
	if = { limit = { th_is_danmaku_creature_type = { type = celestial } } 		th_set_danmaku_creature_type = { type = celestial } }
}

th_add_experience_variable = {
	if = {
		limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
		custom_tooltip = th_add_experience_tt
		hidden_effect = {
			change_variable = {
				which = th_danmaku_current_exp
				which = $input$
			}
			th_gui_update_exp_bar = yes
			while = {
				limit = { check_variable = { which = th_danmaku_current_exp which = th_danmaku_exp_threshold } }
				th_level_up = yes
			}
		}
	}
}

th_add_experience_value = {
	if = {
		limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
		custom_tooltip = th_add_experience_tt
		hidden_effect = {
			change_variable = {
				which = th_danmaku_current_exp
				value = $input$
			}
			th_gui_update_exp_bar = yes
			while = {
				limit = { check_variable = { which = th_danmaku_current_exp which = th_danmaku_exp_threshold } }
				th_level_up = yes
			}
		}
	}
}

th_add_experience = {
	th_add_experience_$type$ = { input = $value$ }
}

th_level_up = {
	if = {
		limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
		custom_tooltip = th_level_up_tt
		hidden_effect = {
			play_sound = th_level_up
			change_variable = {
				which = th_ruler_danmaku_level
				value = 1
			}
			if = {
				limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
				subtract_variable = {
					which = th_danmaku_current_exp
					which = th_danmaku_exp_threshold
				}
				1 = {
					set_variable = {
						which = th_danmaku_default_skill_points_per_level_transfer
						which = th_danmaku_default_skill_points_per_level
					}
					set_variable = {
						which = th_danmaku_default_exp_increase_transfer
						which = th_danmaku_default_exp_increase
					}
					PREV = {
						set_variable = {
							which = th_danmaku_default_skill_points_per_level_transfer
							which = PREV
						}
						set_variable = {
							which = th_danmaku_default_exp_increase_transfer
							which = PREV
						}
					}
				}
				change_variable = {
					which = th_danmaku_available_skill_points
					which = th_danmaku_default_skill_points_per_level_transfer
				}
				#set_variable = {
				#	which = th_danmaku_exp_threshold_old
				#	which = th_danmaku_exp_threshold
				#}
				change_variable = {
					which = th_danmaku_exp_threshold
					which = th_danmaku_default_exp_increase_transfer
				}
				#change_variable = {
				#	which = th_danmaku_exp_threshold
				#	which = th_danmaku_exp_threshold_old
				#}
			}
			else = {
				set_variable = {
					which = th_danmaku_current_exp
					value = 1
				}
				set_variable = {
					which = th_danmaku_exp_threshold
					value = 1
				}
				set_ruler_flag = th_reached_max_level
			}
			th_gui_update_exp_bar = yes
		}
	}
}


th_monthly_country_danmaku_duel_update = {
	if = {
		limit = { th_is_not_in_a_danmaku_duel = yes }
		#Health regeneration
		change_variable = { which = th_danmaku_health which = th_danmaku_hpm }
		if = {
			limit = { check_variable = { which = th_danmaku_health which = th_danmaku_max_health } }
			set_variable = { which = th_danmaku_health which = th_danmaku_max_health }
		}
		if = {
			limit = { NOT = { check_variable = { which = th_danmaku_health value = 0 } } }
			set_variable = { which = th_danmaku_health value = 0 }
		}
		th_gui_update_danmaku_bar_own_ruler = { type = health }
		#Mana regeneration
		change_variable = { which = th_danmaku_mana which = th_danmaku_mpm }
		if = {
			limit = { check_variable = { which = th_danmaku_mana which = th_danmaku_max_mana } }
			set_variable = { which = th_danmaku_mana which = th_danmaku_max_mana }
		}
		if = {
			limit = { NOT = { check_variable = { which = th_danmaku_mana value = 0 } } }
			set_variable = { which = th_danmaku_mana value = 0 }
		}
		th_gui_update_danmaku_bar_own_ruler = { type = mana }
	}
	if = {
		limit = { th_is_duelling_an_unlanded_character = yes }
		th_monthly_danmaku_duel_unlanded_duration_reduction = yes
	}
}


th_define_exp_reward_base = {
	1 = {
		set_variable = {
			which = th_danmaku_default_exp_reward_base_transfer
			which = th_danmaku_default_exp_reward_base
		}
		set_variable = {
			which = th_danmaku_default_exp_scale_transfer
			which = th_danmaku_default_exp_scale
		}
		PREV = {
			set_variable = {
				which = th_danmaku_default_exp_reward_base_transfer
				which = PREV
			}
			set_variable = {
				which = th_danmaku_default_exp_scale_transfer
				which = PREV
			}
		}
	}
	set_variable = {
		which = th_total_exp_gain
		which = th_danmaku_default_exp_reward_base_transfer
	}
	if = {
		limit = { th_is_duelling_an_unlanded_character = yes }
		set_variable = {
			which = th_ruler_danmaku_level_transfer
			which = th_enemy_character_level
		}
	}
	else = {
		event_target:enemy_duelist = {
			set_variable = {
				which = th_ruler_danmaku_level_transfer
				which = th_ruler_danmaku_level
			}
			PREV = {
				set_variable = {
					which = th_ruler_danmaku_level_transfer
					which = PREV
				}
			}
		}
	}
	multiply_variable = {
		which = th_danmaku_default_exp_scale_transfer
		which = th_ruler_danmaku_level_transfer
	}
	change_variable = {
		which = th_total_exp_gain
		which = th_danmaku_default_exp_scale_transfer
	}
}
th_define_exp_reward_win = {
	th_define_exp_reward_base = yes
	1 = {
		set_variable = {
			which = th_danmaku_default_exp_reward_win_transfer
			which = th_danmaku_default_exp_reward_win
		}
		set_variable = {
			which = th_danmaku_default_exp_win_modifier_transfer
			which = th_danmaku_default_exp_win_modifier
		}
		PREV = {
			set_variable = {
				which = th_danmaku_default_exp_reward_win_transfer
				which = PREV
			}
			set_variable = {
				which = th_danmaku_default_exp_win_modifier_transfer
				which = PREV
			}
		}
	}
	change_variable = {
		which = th_total_exp_gain
		which = th_danmaku_default_exp_reward_win
	}
	multiply_variable = {
		which = th_danmaku_default_exp_reward_win_transfer
		which = th_ruler_danmaku_level_transfer
	}
	change_variable = {
		which = th_total_exp_gain
		which = th_danmaku_default_exp_reward_win_transfer
	}
}
th_define_exp_reward = {
	if = {
		limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
		th_define_exp_reward_$type$ = yes
	}
}

th_define_danmaku_gold_reward = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_default_gold_gain_activated value = 1 } } }
		1 = {
			set_variable = {
				which = th_danmaku_base_gold_reward_transfer
				which = th_danmaku_default_gold_reward_base
			}
			if = {
				limit = { check_variable = { which = th_danmaku_default_gold_reward_scale_active value = 1 } }
				set_variable = {
					which = th_danmaku_scale_gold_reward_transfer
					which = th_danmaku_default_gold_reward_scale
				}
			}
			else = {
				set_variable = {
					which = th_danmaku_scale_gold_reward_transfer
					value = 0
				}
			}
			PREV = {
				set_variable = {
					which = th_danmaku_base_gold_reward_transfer
					which = PREV
				}
				set_variable = {
					which = th_danmaku_scale_gold_reward_transfer
					which = PREV
				}
			}
		}
		set_variable = {
			which = th_total_gold_gain
			which = th_danmaku_base_gold_reward_transfer
		}
		if = {
			limit = { th_is_duelling_an_unlanded_character = yes }
			set_variable = {
				which = th_ruler_danmaku_level_transfer
				which = th_enemy_character_level
			}
		}
		else = {
			event_target:enemy_duelist = {
				set_variable = {
					which = th_ruler_danmaku_level_transfer
					which = th_ruler_danmaku_level
				}
				PREV = {
					set_variable = {
						which = th_ruler_danmaku_level_transfer
						which = PREV
					}
				}
			}
		}
		multiply_variable = {
			which = th_danmaku_scale_gold_reward_transfer
			which = th_ruler_danmaku_level_transfer
		}
		change_variable = {
			which = th_total_gold_gain
			which = th_danmaku_scale_gold_reward_transfer
		}
		set_variable = {
			which = th_gold_gain_modifier
			which = th_danmaku_gold_gain
		}
		change_variable = {
			which = th_gold_gain_modifier
			value = 1
		}
		multiply_variable = {
			which = th_total_gold_gain
			which = th_gold_gain_modifier
		}
	}
}

th_define_danmaku_power_reward = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_default_power_gain_activated value = 1 } } }
		1 = {
			set_variable = {
				which = th_danmaku_base_power_reward_transfer
				which = th_danmaku_default_power_reward_base
			}
			if = {
				limit = { check_variable = { which = th_danmaku_default_power_reward_scale_active value = 1 } }
				set_variable = {
					which = th_danmaku_scale_power_reward_transfer
					which = th_danmaku_default_power_reward_scale
				}
			}
			else = {
				set_variable = {
					which = th_danmaku_scale_power_reward_transfer
					value = 0
				}
			}
			PREV = {
				set_variable = {
					which = th_danmaku_base_power_reward_transfer
					which = PREV
				}
				set_variable = {
					which = th_danmaku_scale_power_reward_transfer
					which = PREV
				}
			}
		}
		set_variable = {
			which = th_total_power_gain
			which = th_danmaku_base_power_reward_transfer
		}
		if = {
			limit = { th_is_duelling_an_unlanded_character = yes }
			set_variable = {
				which = th_ruler_danmaku_level_transfer
				which = th_enemy_character_level
			}
		}
		else = {
			event_target:enemy_duelist = {
				set_variable = {
					which = th_ruler_danmaku_level_transfer
					which = th_ruler_danmaku_level
				}
				PREV = {
					set_variable = {
						which = th_ruler_danmaku_level_transfer
						which = PREV
					}
				}
			}
		}
		multiply_variable = {
			which = th_danmaku_scale_power_reward_transfer
			which = th_ruler_danmaku_level_transfer
		}
		change_variable = {
			which = th_total_power_gain
			which = th_danmaku_scale_power_reward_transfer
		}
		set_variable = {
			which = th_power_gain_modifier
			which = th_danmaku_power_gain
		}
		change_variable = {
			which = th_power_gain_modifier
			value = 1
		}
		multiply_variable = {
			which = th_total_power_gain
			which = th_power_gain_modifier
		}
		if = {
			limit = { 1 = { is_variable_equal = { which = th_danmaku_default_power_type value = 4 } } }
			set_country_flag = th_danmaku_power_reward_all
		}
		else_if = {
			limit = { 1 = { is_variable_equal = { which = th_danmaku_default_power_type value = 3 } } }
			set_country_flag = th_danmaku_power_reward_mil
		}
		else_if = {
			limit = { 1 = { is_variable_equal = { which = th_danmaku_default_power_type value = 2 } } }
			set_country_flag = th_danmaku_power_reward_dip
		}
		else_if = {
			limit = { 1 = { is_variable_equal = { which = th_danmaku_default_power_type value = 1 } } }
			set_country_flag = th_danmaku_power_reward_adm
		}
		else = {
			set_country_flag = th_danmaku_power_reward_random
			set_variable = {
				which = th_rng_roll
				value = 0
			}
			th_roll_die_no_variable = {
				die_type = 3
				die_amount = 1
				bonus_per_roll = 0
				result = th_rng_roll
			}
			if = {
				limit = { is_variable_equal = { which = th_rng_roll value = 1 } }
				set_country_flag = th_rng_rolled_adm
			}
			else_if = {
				limit = { is_variable_equal = { which = th_rng_roll value = 2 } }
				set_country_flag = th_rng_rolled_dip
			}
			else = {
				set_country_flag = th_rng_rolled_mil
			}
		}
	}
}

# gold
# power
# exp
th_reward_multiplier = {
	multiply_variable = {
		which = th_total_$type$_gain
		value = $factor$
	}
}

#Suppoorts:
# victory
# draw
th_add_danmaku_exp_reward = {
	if = {
		limit = { NOT = { check_variable = { which = th_ruler_danmaku_level which = th_danmaku_default_max_level } } }
		custom_tooltip = th_add_danmaku_exp_reward_$type$_tt
		hidden_effect = {
			th_add_experience = { type = variable value = th_total_exp_gain }
		}
	}
}
th_add_danmaku_gold_reward = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_default_gold_gain_activated value = 1 } } }
		custom_tooltip = th_add_danmaku_gold_reward_$type$_tt
		hidden_effect = {
			while = {
				limit = { check_variable = { which = th_total_gold_gain value = 1 } }
				add_treasury = 1
				subtract_variable = { which = th_total_gold_gain value = 1 }
			}
			multiply_variable = { which = th_total_gold_gain value = 100 }
			while = {
				limit = { check_variable = { which = th_total_gold_gain value = 1 } }
				add_treasury = 0.01
				subtract_variable = { which = th_total_gold_gain value = 1 }
			}
		}
	}
}
th_add_danmaku_power_reward = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_default_power_gain_activated value = 1 } } }
		if = { limit = { has_country_flag = th_danmaku_power_reward_all } custom_tooltip = th_add_danmaku_all_power_reward_$type$_tt }
		if = { limit = { OR = { has_country_flag = th_danmaku_power_reward_adm has_country_flag = th_rng_rolled_adm } } custom_tooltip = th_add_danmaku_adm_power_reward_$type$_tt }
		if = { limit = { OR = { has_country_flag = th_danmaku_power_reward_dip has_country_flag = th_rng_rolled_dip } } custom_tooltip = th_add_danmaku_dip_power_reward_$type$_tt }
		if = { limit = { OR = { has_country_flag = th_danmaku_power_reward_mil has_country_flag = th_rng_rolled_mil } } custom_tooltip = th_add_danmaku_mil_power_reward_$type$_tt }
		hidden_effect = {
			while = {
				limit = { check_variable = { which = th_total_power_gain value = 1 } }
				trigger_switch = {
					on_trigger = has_country_flag
					th_danmaku_power_reward_all = {
						add_adm_power = 1 add_dip_power = 1 add_mil_power = 1
					}
					th_danmaku_power_reward_adm = { add_adm_power = 1 }
					th_danmaku_power_reward_dip = { add_dip_power = 1 }
					th_danmaku_power_reward_mil = { add_mil_power = 1 }
					th_danmaku_power_reward_random = {
						trigger_switch = {
							on_trigger = has_country_flag
							th_rng_rolled_adm = { add_adm_power = 1 }
							th_rng_rolled_dip = { add_dip_power = 1 }
							th_rng_rolled_mil = { add_mil_power = 1 }
						}
					}
				}
				subtract_variable = { which = th_total_power_gain value = 1 }
			}
			clr_country_flag = th_danmaku_power_reward_all
			clr_country_flag = th_danmaku_power_reward_mil
			clr_country_flag = th_danmaku_power_reward_dip
			clr_country_flag = th_danmaku_power_reward_adm
			clr_country_flag = th_danmaku_power_reward_random
			clr_country_flag = th_rng_rolled_adm
			clr_country_flag = th_rng_rolled_dip
			clr_country_flag = th_rng_rolled_mil
		}
	}
}

th_danmaku_lose_effect = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_default_setting_ruler_death value = 1 } } }
		kill_ruler = yes
	}
	else = {
		add_ruler_modifier = {
			name = th_danmaku_incapacitated
			duration = 730
		}
		custom_tooltip = th_danmaku_incapacitated_tt
		th_add_danmaku_exp_reward = { type = defeat }
	}
}

th_copy_attack_type_and_school_from_weapon = {
	hidden_effect = {
		1 = {
			set_variable = {
				which = th_danmaku_attack_type
				which = th_weapon_$weapon$_damage_type
			}
			set_variable = {
				which = th_danmaku_attack_school
				which = th_weapon_$weapon$_damage_school
			}
			PREV = {
				set_variable = {
					which = th_danmaku_attack_type
					which = PREV
				}
				set_variable = {
					which = th_danmaku_attack_school
					which = PREV
				}
			}
		}
	}
}
th_copy_attack_type_and_school_from_weapon_enemy_character = {
	hidden_effect = {
		1 = {
			set_variable = {
				which = th_enemy_character_damage_type
				which = th_weapon_$weapon$_damage_type
			}
			set_variable = {
				which = th_enemy_character_damage_school
				which = th_weapon_$weapon$_damage_school
			}
			PREV = {
				set_variable = {
					which = th_enemy_character_damage_type
					which = PREV
				}
				set_variable = {
					which = th_enemy_character_damage_school
					which = PREV
				}
			}
		}
	}
}

th_apply_stats_on_ruler = {
	[[physical_attack_bonus]change_variable = { 					which = th_danmaku_physical_attack_bonus 							value = $physical_attack_bonus$ }]
	[[physical_attack_bonus_per_die]change_variable = { 			which = th_danmaku_physical_attack_bonus_per_die					value = $physical_attack_bonus_per_die$ }]
	[[physical_attack_die]change_variable = { 						which = th_danmaku_physical_attack_die 								value = $physical_attack_die$ }]
	[[physical_attack_die_num]change_variable = { 					which = th_danmaku_physical_attack_die_num 							value = $physical_attack_die_num$ }]
	[[physical_crit_roll_needed]change_variable = { 				which = th_danmaku_physical_crit_roll_needed 						value = $physical_crit_roll_needed$ }]
	[[physical_crit_roll_damage_multiplier]change_variable = { 		which = th_danmaku_physical_crit_roll_damage_multiplier 			value = $physical_crit_roll_damage_multiplier$ }]
	[[magical_attack_bonus]change_variable = { 						which = th_danmaku_magical_attack_bonus 							value = $magical_attack_bonus$ }]
	[[magical_attack_bonus_per_die]change_variable = { 				which = th_danmaku_magical_attack_bonus_per_die						value = $magical_attack_bonus_per_die$ }]
	[[magical_attack_die]change_variable = { 						which = th_danmaku_magical_attack_die 								value = $magical_attack_die$ }]
	[[magical_attack_die_num]change_variable = { 					which = th_danmaku_magical_attack_die_num 							value = $magical_attack_die_num$ }]
	[[magical_crit_roll_needed]change_variable = { 					which = th_danmaku_magical_crit_roll_needed 						value = $magical_crit_roll_needed$ }]
	[[magical_crit_roll_damage_multiplier]change_variable = { 		which = th_danmaku_magical_crit_roll_damage_multiplier 				value = $magical_crit_roll_damage_multiplier$ }]
	[[psionic_attack_bonus]change_variable = { 						which = th_danmaku_psionic_attack_bonus 							value = $psionic_attack_bonus$ }]
	[[psionic_attack_bonus_per_die]change_variable = { 				which = th_danmaku_psionic_attack_bonus_per_die						value = $psionic_attack_bonus_per_die$ }]
	[[psionic_attack_die]change_variable = { 						which = th_danmaku_psionic_attack_die 								value = $psionic_attack_die$ }]
	[[psionic_attack_die_num]change_variable = { 					which = th_danmaku_psionic_attack_die_num 							value = $psionic_attack_die_num$ }]
	[[psionic_crit_roll_needed]change_variable = { 					which = th_danmaku_psionic_crit_roll_needed 						value = $psionic_crit_roll_needed$ }]
	[[psionic_crit_roll_damage_multiplier]change_variable = { 		which = th_danmaku_psionic_crit_roll_damage_multiplier 				value = $psionic_crit_roll_damage_multiplier$ }]
}
th_apply_stats_on_unlanded_character = {
	[[physical_attack_bonus]set_variable = { 						which = th_enemy_character_physical_attack_bonus 					value = $physical_attack_bonus$ }]
	[[physical_attack_bonus_per_die]set_variable = { 				which = th_enemy_character_physical_attack_bonus_per_die			value = $physical_attack_bonus_per_die$ }]
	[[physical_attack_die]set_variable = { 							which = th_enemy_character_physical_attack_die 						value = $physical_attack_die$ }]
	[[physical_attack_die_num]set_variable = { 						which = th_enemy_character_physical_attack_die_num 					value = $physical_attack_die_num$ }]
	[[physical_crit_roll_needed]set_variable = { 					which = th_enemy_character_physical_crit_roll_needed 				value = $physical_crit_roll_needed$ }]
	[[physical_crit_roll_damage_multiplier]set_variable = { 		which = th_enemy_character_physical_crit_roll_multiplier 			value = $physical_crit_roll_damage_multiplier$ }]
	[[magical_attack_bonus]set_variable = { 						which = th_enemy_character_magical_attack_bonus 					value = $magical_attack_bonus$ }]
	[[magical_attack_bonus_per_die]set_variable = { 				which = th_enemy_character_magical_attack_bonus_per_die				value = $magical_attack_bonus_per_die$ }]
	[[magical_attack_die]set_variable = { 							which = th_enemy_character_magical_attack_die 						value = $magical_attack_die$ }]
	[[magical_attack_die_num]set_variable = { 						which = th_enemy_character_magical_attack_die_num 					value = $magical_attack_die_num$ }]
	[[magical_crit_roll_needed]set_variable = { 					which = th_enemy_character_magical_crit_roll_needed 				value = $magical_crit_roll_needed$ }]
	[[magical_crit_roll_damage_multiplier]set_variable = { 			which = th_enemy_character_magical_crit_roll_multiplier 			value = $magical_crit_roll_damage_multiplier$ }]
	[[psionic_attack_bonus]set_variable = { 						which = th_enemy_character_psionic_attack_bonus 					value = $psionic_attack_bonus$ }]
	[[psionic_attack_bonus_per_die]set_variable = { 				which = th_enemy_character_psionic_attack_bonus_per_die				value = $psionic_attack_bonus_per_die$ }]
	[[psionic_attack_die]set_variable = { 							which = th_enemy_character_psionic_attack_die 						value = $psionic_attack_die$ }]
	[[psionic_attack_die_num]set_variable = { 						which = th_enemy_character_psionic_attack_die_num 					value = $psionic_attack_die_num$ }]
	[[psionic_crit_roll_needed]set_variable = { 					which = th_enemy_character_psionic_crit_roll_needed 				value = $psionic_crit_roll_needed$ }]
	[[psionic_crit_roll_damage_multiplier]set_variable = { 			which = th_enemy_character_psionic_crit_roll_multiplier 			value = $psionic_crit_roll_damage_multiplier$ }]
}

th_equip_currently_selected_weapon = {
	custom_tooltip = th_equip_currently_selected_weapon_item_tt
	hidden_effect = {
		set_variable = {
			which = th_danmaku_weapon_equipped
			which = th_selected_weapon
		}
		play_sound = th_equip_minor_weapon
		th_get_weapon_attack_and_apply = yes
	}
}

th_get_weapon_attack_and_apply = {
	hidden_effect = {
		#upgraded weapon
		#if = {
		#	limit = { always = no }
		#}
		#else = {
		#	
		#}
		if = {
			limit = { th_has_equipped_any_weapon = yes }
			if = {
				limit = { th_has_equipped_weapon = { weapon = iron_sword } }
				th_apply_default_weapon_stats = { weapon = iron_sword who = ruler }
			}
		}
	}
}

th_setup_type_resistance = {
	set_variable = {
		which = th_danmaku_$type$_resistance
		value = $value$
	}
}
th_setup_school_resistance = {
	set_variable = {
		which = th_danmaku_$school$_resistance
		value = $value$
	}
}

th_setup_enemy_character_type_resistance = {
	set_variable = {
		which = th_enemy_character_$type$_resistance
		value = $value$
	}
}
th_setup_enemy_character_school_resistance = {
	set_variable = {
		which = th_enemy_character_$school$_resistance
		value = $value$
	}
}

th_setup_max_resource = {
	set_variable = {
		which = th_danmaku_max_$type$
		value = $value$
	}
	set_variable = {
		which = th_danmaku_$type$
		value = $value$
	}
	th_gui_update_danmaku_bar_own_ruler = {
		type = $type$
	}
}
th_setup_enemy_character_max_resource = {
	set_variable = {
		which = th_enemy_character_max_$type$
		value = $value$
	}
	set_variable = {
		which = th_enemy_character_$type$
		value = $value$
	}
	th_gui_update_danmaku_bar_enemy_character = {
		type = $type$
	}
}

th_post_danmaku_trigger_event_from_key_victory_flavor_cin = { country_event = { id = flavor_cin.7 } }
th_post_danmaku_trigger_event_from_key_victory_cin_vs_clp = { country_event = { id = flavor_cin.24 } }
th_post_danmaku_trigger_event_from_key_victory = {
	th_post_danmaku_trigger_event_from_key_victory_$event_key$ = yes
}
th_post_danmaku_trigger_event_from_key_draw_flavor_cin = { country_event = { id = flavor_cin.7 } }
th_post_danmaku_trigger_event_from_key_draw_cin_vs_clp = { country_event = { id = flavor_cin.24 } }
th_post_danmaku_trigger_event_from_key_draw = {
	th_post_danmaku_trigger_event_from_key_draw_$event_key$ = yes
}
th_post_danmaku_trigger_event_from_key_defeat_flavor_cin = { country_event = { id = flavor_cin.8 } }
th_post_danmaku_trigger_event_from_key_defeat_cin_vs_clp = { country_event = { id = flavor_cin.25 } }
th_post_danmaku_trigger_event_from_key_defeat = {
	th_post_danmaku_trigger_event_from_key_defeat_$event_key$ = yes
}
th_post_danmaku_trigger_event_from_key = {
	th_post_danmaku_trigger_event_from_key_$type$ = { event_key = $event_key$ }
}
th_post_danmaku_trigger_events = {
	if = {
		limit = { th_post_danmaku_has_event_key = { event_key = flavor_cin } }
		clr_country_flag = th_danmaku_post_fight_event_key_flavor_cin
		th_post_danmaku_trigger_event_from_key = { type = $type$ event_key = flavor_cin }
	}
	if = {
		limit = { th_post_danmaku_has_event_key = { event_key = cin_vs_clp } }
		clr_country_flag = th_danmaku_post_fight_event_key_cin_vs_clp
		th_post_danmaku_trigger_event_from_key = { type = $type$ event_key = cin_vs_clp }
	}
}