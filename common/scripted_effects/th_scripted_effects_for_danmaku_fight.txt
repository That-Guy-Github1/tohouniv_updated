th_prepare_country_for_danmaku_duel = {
	set_country_flag = th_is_in_a_danmaku_duel
	set_ruler_flag = th_ruler_is_in_a_danmaku_duel
	set_variable = {
		which = th_danmaku_action_points
		which = th_danmaku_max_action_points
	}
	th_gui_update_danmaku_bar = { type = action_points }
}

th_assign_country_to_danmaku_duel_instance = {
	th_prepare_country_for_danmaku_duel = yes
	set_country_flag = th_is_in_danmaku_duel_instance_$instance$
	set_ruler_flag = th_is_country_$country_id$_in_danmaku_duel_of_$instance$
	save_global_event_target_as = th_danmaku_duelist_of_id_$country_id$_of_instance_$instance$
}

th_setup_danmaku_duel_instance = {
	set_variable = {
		which = th_danmaku_duel_instance_$instance$_round_counter
		value = 1
	}
	set_variable = {
		which = th_danmaku_duel_instance_$instance$_opponent_turn	#Is 0 for the first striker, is 1 for the second striker. Gets reset to 0 after the second striker ends turn so initiative can be rerolled.
		value = 0
	}
	set_variable = {
		which = th_danmaku_duel_instance_$instance$_turn_duration_counter
		which = th_dnamaku_default_turn_duration
	}
	set_variable = {
		which = th_danmaku_duel_logged_actions_for_instance_$instance$
		value = 0
	}
	set_province_flag = th_danmaku_duel_instance_$instance$_online
}

th_gui_set_enemy_bar = {
	$country_1$ = {
		set_variable = {
			which = th_danmaku_source_transfer_$type$
			which = th_danmaku_$type$_var
		}
		$country_2$ = {
			set_variable = {
				which = th_danmaku_source_transfer_$type$
				which = PREV
			}
			set_variable = { 
				which = th_danmaku_enemy_$type$_var 
				which = th_danmaku_source_transfer_$type$ 
			}
			set_variable = {
				which = th_danmaku_target_transfer_$type$
				which = th_danmaku_$type$_var
			}
			$country_1$ = {
				set_variable = {
					which = th_danmaku_target_transfer_$type$
					which = PREV
				}
				set_variable = { 
					which = th_danmaku_enemy_$type$_var 
					which = th_danmaku_target_transfer_$type$ 
				}
			}
		}
	}
}

th_create_danmaku_duel_instance = {
	if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_1_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 1 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 1 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 1 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_2_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 2 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 2 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 2 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_3_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 3 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 3 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 3 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_4_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 4 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 4 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 4 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_5_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 5 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 5 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 5 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_6_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 6 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 6 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 6 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_7_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 7 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 7 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 7 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_8_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 8 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 8 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 8 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_9_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 9 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 9 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 9 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_10_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 10 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 10 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 10 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_11_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 11 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 11 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 11 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_12_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 12 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 12 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 12 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_13_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 13 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 13 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 13 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_14_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 14 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 14 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 14 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_15_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 15 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 15 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 15 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_16_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 16 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 16 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 16 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_17_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 17 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 17 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 17 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_18_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 18 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 18 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 18 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_19_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 19 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 19 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 19 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_20_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 20 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 20 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 20 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_21_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 21 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 21 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 21 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_22_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 22 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 22 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 22 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_23_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 23 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 23 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 23 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_24_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 24 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 24 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 24 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_25_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 25 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 25 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 25 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_26_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 26 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 26 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 26 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_27_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 27 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 27 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 27 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_28_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 28 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 28 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 28 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_29_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 29 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 29 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 29 }
	}
	else_if = {
		limit = { NOT = { has_province_flag = th_danmaku_duel_instance_30_online } }
		$country_1$ = { th_assign_country_to_danmaku_duel_instance = { instance = 30 country_id = 1 } }
		$country_2$ = { th_assign_country_to_danmaku_duel_instance = { instance = 30 country_id = 2 } }
		th_setup_danmaku_duel_instance = { instance = 30 }
	}
	else = {
		log = "Too many Danmaku Duel instances were called. Could not add $country_1$ and $country_2$ to a duel."
	}
}

th_roll_initiative = {
	custom_tooltip = th_roll_initiative_tt
	hidden_effect = {
		set_variable = {
			which = th_danmaku_rolled_initiative
			value = 0
		}
		random_list = {
			1 = { change_variable = { which = th_danmaku_rolled_initiative value = 1 } }
			1 = { change_variable = { which = th_danmaku_rolled_initiative value = 2 } }
			1 = { change_variable = { which = th_danmaku_rolled_initiative value = 3 } }
			1 = { change_variable = { which = th_danmaku_rolled_initiative value = 4 } }
		}
		change_variable = {
			which = th_danmaku_rolled_initiative
			which = th_danmaku_ini_bonus
		}
	}
}
th_alternative_roll_initiative = {	#I LOOOOOOOOVE EU4's inability to have random numbers
	custom_tooltip = th_roll_initiative_tt
	hidden_effect = {
		export_to_variable = {
			which = th_danmaku_randomizer
			value = max_manpower
		}
		export_to_variable = {
			which = $variable$
			value = manpower
		}
		change_variable = {
			which = th_danmaku_randomizer
			which = $variable$
		}
		divide_variable = {
			which = th_danmaku_randomizer
			value = 2
		}
		set_variable = {
			which = $variable$
			which = th_danmaku_randomizer
		}
		random = {
			chance = 0.25
			change_variable = {
				which = th_danmaku_randomizer
				value = 1
			}
		}
		random = {
			chance = 0.25
			change_variable = {
				which = th_danmaku_randomizer
				value = 2
			}
		}
		random = {
			chance = 0.25
			change_variable = {
				which = th_danmaku_randomizer
				value = 3
			}
		}
		divide_variable = {
			which = th_danmaku_randomizer
			value = 4
		}
		round_variable = {
			which = th_danmaku_randomizer
			value = -1
		}
		multiply_variable = {
			which = th_danmaku_randomizer
			value = 4
		}
		subtract_variable = {
			which = $variable$
			which = th_danmaku_randomizer
		}
		round_variable = {
			which = $variable$
			value = 0
		}
		change_variable = {
			which = $variable$
			which = $bonus$
		}
	}
}

th_roll_initiative_for_current_instance = {
	custom_tooltip = th_roll_initiative_for_current_instance_tt
	hidden_effect = {
		$country_1$ = { th_roll_initiative = yes }
		$country_2$ = {
			th_alternative_roll_initiative = {
				variable = th_danmaku_rolled_initiative
				bonus = th_danmaku_ini_bonus
			}
			set_variable = {
				which = th_danmaku_rolled_initiative_transfer
				which = th_danmaku_rolled_initiative
			}
			while = {
				limit = {
					NOT = {
						is_variable_equal = {
							which = th_danmaku_rolled_initiative_transfer
							value = 0
						}
					}
				}
				if = {
					limit = { check_variable = { which = th_danmaku_rolled_initiative_transfer value = 1 } }
					change_variable = { which = th_danmaku_rolled_initiative_transfer value = -1 }
				}
				else = {
					change_variable = { which = th_danmaku_rolled_initiative_transfer value = 1 }
				}
				$country_1$ = { change_variable = { which = th_danmaku_rolled_initiative_comperator value = 1 } }
			}
		}
		$country_1$ = {
			if = {
				limit = {
					check_variable = {
						which = th_danmaku_rolled_initiative
						which = th_danmaku_rolled_initiative_comperator
					}
				}
				set_ruler_flag = th_danmaku_has_turn_ownership
				th_on_new_own_turn = yes
				$country_2$ = {
					set_ruler_flag = th_danmaku_has_not_turn_ownership
					th_on_new_enemy_turn = yes
				}
			}
			else = {
				set_ruler_flag = th_danmaku_has_not_turn_ownership
				$country_2$ = {
					set_ruler_flag = th_danmaku_has_turn_ownership
					th_on_new_own_turn = yes
				}
			}
		}
	}
}

th_roll_initiative_for_root_scope = {
	$opponent$ = { custom_tooltip = th_roll_initiative_root_for_current_instance_tt }
	hidden_effect = {
		$opponent$ = { th_roll_initiative = yes }
		th_alternative_roll_initiative = {
			variable = th_danmaku_rolled_initiative
			bonus = th_danmaku_ini_bonus
		}
		set_variable = {
			which = th_danmaku_rolled_initiative_transfer
			which = th_danmaku_rolled_initiative
		}
		while = {
			limit = {
				NOT = {
					is_variable_equal = {
						which = th_danmaku_rolled_initiative_transfer
						value = 0
					}
				}
			}
			if = {
				limit = { check_variable = { which = th_danmaku_rolled_initiative_transfer value = 1 } }
				change_variable = { which = th_danmaku_rolled_initiative_transfer value = -1 }
			}
			else = {
				change_variable = { which = th_danmaku_rolled_initiative_transfer value = 1 }
			}
			$opponent$ = { change_variable = { which = th_danmaku_rolled_initiative_comperator value = 1 } }
		}
		$opponent$ = {
			if = {
				limit = {
					check_variable = {
						which = th_danmaku_rolled_initiative
						which = th_danmaku_rolled_initiative_comperator
					}
				}
				set_ruler_flag = th_danmaku_has_turn_ownership
				th_on_new_own_turn = yes
				prev = {
					set_ruler_flag = th_danmaku_has_not_turn_ownership
					th_on_new_enemy_turn = yes
				}
			}
			else = {
				set_ruler_flag = th_danmaku_has_not_turn_ownership
				th_on_new_enemy_turn = yes
				prev = {
					set_ruler_flag = th_danmaku_has_turn_ownership
					th_on_new_own_turn = yes
				}
			}
		}
	}
}

th_create_event_target_enemy_duelist = {
	save_event_target_as = root_duelist
	if = {
		limit = { th_is_not_duelling_an_unlanded_character = yes }
		th_select_enemy_event_target_and_do_effect = {
			effect = "save_event_target_as = enemy_duelist"
		}
		if = {
			limit = { NOT = { has_saved_event_target = enemy_duelist } }
			log = "Could not create enemy_duelist event_target. Maybe the enemy country does not exist?"
		}
	}
}

th_clear_invalid_combat_instance = {
	if = {
		limit = { tag = event_target:th_danmaku_duelist_of_id_1_of_instance_$instance$ }
		event_target:th_danmaku_duelist_of_id_2_of_instance_$instance$ = {
			th_force_clear_combat_for_instance = { instance = $instance$ }
			country_event = {
				id = th_danmaku_duel_event.6
			}
		}
	}
	if = {
		limit = { tag = event_target:th_danmaku_duelist_of_id_2_of_instance_$instance$ }
		event_target:th_danmaku_duelist_of_id_1_of_instance_$instance$ = {
			th_force_clear_combat_for_instance = { instance = $instance$ }
			country_event = {
				id = th_danmaku_duel_event.6
			}
		}
	}
}


th_create_danmaku_duel_against_country = {
	if = {
		limit = {
			tag = $country_1$
			tag = $country_2$
		}
		log = "Called a Danmaku Duel against itself. That is not possible."
	}
	else_if = {
		limit = {
			OR = {
				$country_1$ = { th_is_in_a_danmaku_duel = yes }
				$country_2$ = { th_is_in_a_danmaku_duel = yes }
			}
		}
		log = "Either country is already in a danmaku duel."
	}
	else = {
		if = {
			limit = { tag = $country_1$ }
			$country_2$ = { custom_tooltip = th_create_danmaku_duel_instance_against_root_tt }
		}
		else_if = {
			limit = { tag = $country_2$ }
			$country_1$ = { custom_tooltip = th_create_danmaku_duel_instance_against_root_tt }
		}
		else = {
			$country_1$ = { custom_tooltip = th_join_danmaku_duel_instance_tt }
			$country_2$ = { custom_tooltip = th_join_danmaku_duel_instance_tt }
			custom_tooltip = th_create_danmaku_duel_instance_tt
		}
		hidden_effect = {
			th_global_setup_danmaku_duels_data = yes
			1 = {
				if = {
					limit = {
						NOT = {
							check_variable = {
								which = th_danmaku_duel_counter
								which = th_danmaku_max_duels
							}
						}
					}
					change_variable = {
						which = th_danmaku_duel_counter
						value = 1
					}
					th_create_danmaku_duel_instance = {
						country_1 = $country_1$
						country_2 = $country_2$
					}
					th_roll_initiative_for_current_instance = {
						country_1 = $country_1$
						country_2 = $country_2$
					}
				}
				else = {
					log = "Too many Danmaku Duel instances were called..."
				}
			}
			th_gui_set_enemy_bar = { country_1 = $country_1$ country_2 = $country_2$ type = health }
			th_gui_set_enemy_bar = { country_1 = $country_1$ country_2 = $country_2$ type = mana }
		}
	}
}


th_change_danmaku_specific_instance_round = {
	hidden_effect = {
		1 = {
			if = {
				limit = { NOT = { check_variable = { which = th_danmaku_duel_instance_$instance$_opponent_turn value = 1 } } }
				1 = { set_variable = { which = th_danmaku_duel_instance_$instance$_opponent_turn value = 1 } }
			}
			else = {
				1 = {
					set_variable = { which = th_danmaku_duel_instance_$instance$_opponent_turn value = 0 }
					change_variable = { which = th_danmaku_duel_instance_$instance$_round_counter value = 1 }
				}
			}
			set_variable = {
				which = th_danmaku_duel_instance_$instance$_turn_duration_counter
				which = th_dnamaku_default_turn_duration
			}
		}
	}
	if = {
		limit = {
			1 = {
				NOT = { check_variable = { which = th_danmaku_duel_instance_$instance$_opponent_turn value = 0 } }
				check_variable = { which = th_danmaku_default_setting_reroll_initiative value = 1 }
			}
		}
		th_roll_initiative_for_root_scope = { opponent = $opponent$ }
	}
	else = {
		if = {
			limit = { $opponent$ = { th_has_turn_ownership = yes } }
			$opponent$ = {
				custom_tooltip = th_end_turn_for_this_ruler_tt
				clr_ruler_flag = th_danmaku_has_turn_ownership
				set_ruler_flag = th_danmaku_has_not_turn_ownership
				th_on_new_enemy_turn = yes
			}
			custom_tooltip = th_start_turn_for_this_ruler_tt
			set_ruler_flag = th_danmaku_has_turn_ownership
			clr_ruler_flag = th_danmaku_has_not_turn_ownership
			th_on_new_own_turn = yes
		}
		else = {
			$opponent$ = {
				custom_tooltip = th_start_turn_for_this_ruler_tt
				set_ruler_flag = th_danmaku_has_turn_ownership
				clr_ruler_flag = th_danmaku_has_not_turn_ownership
				th_on_new_own_turn = yes
			}
			custom_tooltip = th_end_turn_for_this_ruler_tt
			clr_ruler_flag = th_danmaku_has_turn_ownership
			set_ruler_flag = th_danmaku_has_not_turn_ownership
			th_on_new_enemy_turn = yes
		}
	}
}

#General Interaction mechanics
th_end_turn = {
	hidden_effect = {
		if = {
			limit = { th_is_not_duelling_an_unlanded_character = yes }
			th_select_enemy_event_target_and_do_effect = {
				effect = "
					th_change_danmaku_instance_round = { opponent = root }
				"
			}
		}
		else = {
			th_end_turn_against_unlanded_character = yes
		}
	}
}

th_monthly_danaku_duel_duration_reduction = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_duel_instance_$instance$_turn_duration_counter value = 0 } } }
		1 = {
			subtract_variable = {
				which = th_danmaku_duel_instance_$instance$_turn_duration_counter
				value = 1
			}
		}
		if = {
			limit = {
				1 = { NOT = { check_variable = { which = th_danmaku_duel_instance_$instance$_turn_duration_counter value = 1 } } }
				has_saved_global_event_target = th_danmaku_duelist_of_id_1_of_instance_$instance$
				has_saved_global_event_target = th_danmaku_duelist_of_id_2_of_instance_$instance$
			}
			if = {
				limit = { event_target:th_danmaku_duelist_of_id_1_of_instance_$instance$ = { th_has_turn_ownership = yes } }
				event_target:th_danmaku_duelist_of_id_1_of_instance_$instance$ = { th_change_danmaku_instance_round = { opponent = event_target:th_danmaku_duelist_of_id_2_of_instance_$instance$ } }
			}
			else = {
				event_target:th_danmaku_duelist_of_id_2_of_instance_$instance$ = { th_change_danmaku_instance_round = { opponent = event_target:th_danmaku_duelist_of_id_1_of_instance_$instance$ } }
			}
		}
	}
}

th_gui_get_enemy_resource_bar = {
	if = {
		limit = { has_saved_event_target = enemy_duelist }
		event_target:enemy_duelist = {
			set_variable = {
				which = th_danmaku_source_transfer_$type$
				which = th_danmaku_$type$_var
			}
			PREV = {
				set_variable = {
					which = th_danmaku_source_transfer_$type$
					which = PREV
				}
				set_variable = { 
					which = th_danmaku_enemy_$type$_var 
					which = th_danmaku_source_transfer_$type$ 
				}
			}
		}
	}
}

th_gui_update_enemy_resource_bar = {
	set_variable = {
		which = th_danmaku_source_transfer_$type$
		which = th_danmaku_$type$_var
	}
	th_create_event_target_enemy_duelist = yes
	if = {
		limit = { has_saved_event_target = enemy_duelist }
		event_target:enemy_duelist = {
			set_variable = {
				which = th_danmaku_source_transfer_$type$
				which = PREV
			}
			set_variable = { 
				which = th_danmaku_enemy_$type$_var 
				which = th_danmaku_source_transfer_$type$ 
			}
		}
	}
}

th_change_combat_resource = {
	change_variable = {
		which = th_danmaku_$type$
		value = $value$
	}
	if = {
		limit = { NOT = { check_variable = { which = th_danmaku_$type$ value = 0 } } }
		set_variable = {
			which = th_danmaku_$type$
			value = 0
		}
	}
	if = {
		limit = { check_variable = { which = th_danmaku_$type$ which = th_danmaku_max_$type$ } }
		set_variable = {
			which = th_danmaku_$type$
			which = th_danmaku_max_$type$
		}
	}
	th_gui_update_danmaku_bar = { type = $type$ }
	th_gui_update_enemy_resource_bar = { type = $type$ }
}
th_set_combat_resource = {
	set_variable = {
		which = th_danmaku_$type$
		value = $value$
	}
	if = {
		limit = { NOT = { check_variable = { which = th_danmaku_$type$ value = 0 } } }
		set_variable = {
			which = th_danmaku_$type$
			value = 0
		}
	}
	if = {
		limit = { check_variable = { which = th_danmaku_$type$ which = th_danmaku_max_$type$ } }
		set_variable = {
			which = th_danmaku_$type$
			which = th_danmaku_max_$type$
		}
	}
	th_gui_update_danmaku_bar = { type = $type$ }
	th_gui_update_enemy_resource_bar = { type = $type$ }
}
th_reset_combat_resource = {
	set_variable = {
		which = th_danmaku_$type$
		which = th_danmaku_max_$type$
	}
	if = {
		limit = { NOT = { check_variable = { which = th_danmaku_$type$ value = 0 } } }
		set_variable = {
			which = th_danmaku_$type$
			value = 0
		}
	}
	th_gui_update_danmaku_bar = { type = $type$ }
	th_gui_update_enemy_resource_bar = { type = $type$ }
}

th_on_new_own_turn = {
	th_reset_combat_resource = { type = action_points }
}

th_on_new_enemy_turn = {}

th_check_if_kill = {
	if = {
		limit = { NOT = { th_is_alive = yes } }
		set_ruler_flag = th_danmaku_duel_over
		PREV = { set_ruler_flag = th_danmaku_duel_over }
		if = {
			limit = { PREV = { th_is_alive = yes } }
			th_on_defeat = yes
			PREV = { th_on_win = yes }
		}
		else = {
			th_on_draw = yes
			PREV = { th_on_draw = yes }
		}
	}
}

th_on_win = {
	add_stability = 3		#TODO
	country_event = {
		id = th_danmaku_duel_event.1
	}
}
th_on_defeat = {
	th_play_sound = { sound = th_danmaku_death }
	add_stability = -3
	country_event = {
		id = th_danmaku_duel_event.2
	}
}
th_on_draw = {
	country_event = {
		id = th_danmaku_duel_event.3
	}
}

th_generate_random_number = {
	1 = {
		[[input_variable]
			change_variable = {
				which = rng_used_custom_input
				value = 1
			}
			change_variable = {
				which = rng_used_custom_input_2
				which = rng_used_custom_input
			}
			multiply_variable = {
				which = rng_used_custom_input
				which = rng_used_custom_input_2
			}
			if = {
				limit = { check_variable = { which = rng_used_custom_input value = 1400 } }
				subtract_variable = { which = rng_used_custom_input value = 1100 }
			}
			PREV = {
				set_variable = { which = rng_transfer_input_variable which = $input_variable$ }
				if = {
					limit = { NOT = { check_variable = { which = rng_transfer_input_variable value = 0 } } }
					multiply_variable = { which = rng_transfer_input_variable value = -1 }
				}
				1 = { set_variable = { which = rng_transfer_input_variable which = PREV } }
			}
			multiply_variable = {
				which = rng_transfer_input_variable
				which = rng_used_custom_input
			}
			modulo_variable = { which = rng_transfer_input_variable value = 1401 }
			set_variable = { which = rnroller which = rnroller }
		]
		# any value above 1460 will go over the variable size limit of eu4 i'm cutting it at 1400 for safety
		if = {
			limit = { check_variable = { which = rnroller value = 1400 } }
			#200 is a good starting value anything lower than 100 will start being too predictable 
			subtract_variable = { which = rnroller value = 1200 }
		}
		set_variable = { 		which = rnroller2	 which = rnroller }
		multiply_variable = { 	which = rnroller2	 which = rnroller }
		change_variable = { 	which = rnroller2	 value = 11 }
		change_variable = { 	which = rnroller2	 which = rnroller }
		divide_variable = { 	which = rnroller2	 value = 83 }
		set_variable = { 		which = rnroller3	 which = rnroller }
		multiply_variable = { 	which = rnroller3	 which = rnroller }
		divide_variable = { 	which = rnroller3	 value = 6 }
		change_variable = { 	which = rnroller3	 value = 29 }
		modulo_variable = { 	which = rnroller3	 value = 89 }
		multiply_variable = { 	which = rnroller2	 which = rnroller3 }
		modulo_variable = { 	which = rnroller2	 value = 100 }
		random_variable = { 	which = rnroller3	 value = 100 }
		change_variable = { 	which = rnroller3	 value = 1 }
		round_variable = { 		which = rnroller3	 value = 0 }
		change_variable = { 	which = rnroller	 which = rnroller3 }
		#User Input section
		set_variable = { which = rng_modulo value = 0 }
		[[modulo]
		PREV = {
			set_variable = { which = rng_modulo which = $modulo$ }
			1 = { set_variable = { which = rng_modulo which = PREV } }
		}
		]
		[[modulo_number]set_variable = { which = rng_modulo value = $modulo_number$ }]
		if = {
			limit = { check_variable = { which = rng_modulo value = 2 } }
			modulo_variable = { which = rnroller2 which = rng_modulo }
			change_variable = { which = rnroller2 value = 1 }
		}
		#Transfer number to PREV scope
		PREV = {
			add_stability = 1
			change_variable = {
				which = $rng_variable$
				value = 0
			}
		}
		while = {
			limit = { check_variable = { which = rnroller2 value = 1 } }
			PREV = { change_variable = { which = $rng_variable$ value = 1 } }
			subtract_variable = { which = rnroller2 value = 1 }
		}
	}
}

th_roll_die = {
	if = {
		limit = {
			check_variable = { which = $die_type$ value = 2 }
			check_variable = { which = $die_amount$ value = 1 }
		}
		save_global_event_target_as = rng_generator
		set_variable = {
			which = th_roll_amount
			which = $die_amount$
		}
		set_variable = {
			which = th_bonus_per_roll
			which = $bonus_per_roll$
		}
		#set_country_flag = th_used_die_for_$purpose$
		set_variable = { which = th_roll_die_type which = $die_type$ }

		#Generate country specific random number
		export_to_variable = {
			variable_name = rng_input
			value = manpower
			who = ROOT
		}
		export_to_variable = {
			variable_name = rng_input_treasury
			value = treasury
			who = ROOT
		}
		change_variable = {
			which = rng_input
			which = rng_input_treasury
		}
		export_to_variable = {
			variable_name = rng_input_max_manpower
			value = max_manpower
			who = ROOT
		}
		change_variable = {
			which = rng_input
			which = rng_input_max_manpower
		}
		#Total result
		set_variable = {
			which = rng_result
			value = 0
		}
		#Generating the numbers
		while = {
			limit = { check_variable = { which = th_roll_amount value = 1 } }
			th_generate_random_number = {
				input_variable = rng_input
				modulo = th_roll_die_type
				rng_variable = rng_result
			}
			change_variable = {
				which = rng_result
				which = th_bonus_per_roll
			}
			subtract_variable = { which = th_roll_amount value = 1 }
		}
		change_variable = {
			which = $result$
			which = rng_result
		}
		# The "kill-random-guy" RNG approach
		# th_select_country_for_monarch_kill_on_action = yes
		# event_target:rng_maker = {
		# 	set_variable = { which = th_bonus_per_roll which = PREV }
		# 	set_variable = { which = th_roll_amount which = PREV }
		# 	set_variable = { which = th_roll_die_type which = PREV }
		# 	th_trigger_on_monarch_death_on_action = yes
		# }
		# if = { limit = { check_variable = { which = th_roll_amount value = 2 } }
		# 	set_variable = { which = th_roll_die_type which = $die_type$ }
		# 	th_select_country_for_monarch_kill_on_action = yes
		# 	event_target:rng_maker = {
		# 		set_variable = { which = th_bonus_per_roll which = PREV }
		# 		set_variable = { which = th_roll_amount which = PREV }
		# 		set_variable = { which = th_roll_die_type which = PREV }
		# 		th_trigger_on_monarch_death_on_action = yes
		# 	}
		# }
	}
	else = {
		log = "Cannot roll due to few dies or too small dies."
	}
}

th_roll_die_no_variable = {
	set_variable = { which = th_roll_die_type value = $die_type$ }
	set_variable = { which = th_roll_amount value = $die_amount$ }
	if = {
		limit = {
			check_variable = { which = th_roll_die_type value = 2 }
			check_variable = { which = th_roll_amount value = 1 }
		}
		set_variable = {
			which = th_bonus_per_roll
			value = $bonus_per_roll$
		}
		#Generate country specific random number
		export_to_variable = {
			which = rng_input
			value = manpower
		}
		export_to_variable = {
			which = rng_input_treasury
			value = treasury
		}
		change_variable = {
			which = rng_input
			which = rng_input_treasury
		}
		export_to_variable = {
			which = rng_input_max_manpower
			value = max_manpower
		}
		change_variable = {
			which = rng_input
			which = rng_input_max_manpower
		}
		#Total result
		set_variable = {
			which = rng_result
			value = 0
		}
		#Generating the numbers
		while = {
			limit = { check_variable = { which = th_roll_amount value = 1 } }
			th_generate_random_number = {
				input_variable = rng_input
				modulo = th_roll_die_type
				rng_variable = rng_result
			}
			change_variable = {
				which = rng_result
				which = th_bonus_per_roll
			}
			subtract_variable = { which = th_roll_amount value = 1 }
		}
		change_variable = {
			which = $result$
			which = rng_result
		}
	}
	else = {
		log = "Cannot roll due to few dies or too small dies."
	}
}

th_perform_attack = {
	if = {
		limit = { has_saved_event_target = enemy_duelist }
		set_variable = {
			which = th_danmaku_attack_roll
			value = 0
		}
		set_variable = {
			which = th_danmaku_attack_roll_amount
			value = 1
		}
		set_variable = {
			which = th_danmaku_attack_roll_die_type
			value = 20
		}
		set_variable = {
			which = th_danmaku_hit_bonus_per_roll
			value = 0
		}
		th_roll_die = {
			die_type = th_danmaku_attack_roll_die_type
			die_amount = th_danmaku_attack_roll_amount
			bonus_per_roll = th_danmaku_hit_bonus_per_roll
			result = th_danmaku_attack_roll
		}
		if = {
			limit = {
				check_variable = {
					which = th_danmaku_attack_roll
					which = th_danmaku_crit_roll_needed
				}
			}
			set_ruler_flag = th_danmaku_rolled_critical_hit
		}
		change_variable = {
			which = th_danmaku_attack_roll
			which = th_danmaku_hit_bonus
		}
		event_target:enemy_duelist = {
			set_variable = {
				which = th_danmaku_enemy_armor_class_transfer
				which = th_danmaku_armor_class
			}
			PREV = {
				set_variable = {
					which = th_danmaku_enemy_armor_class_transfer
					which = PREV
				}
			}
		}
		th_log_memorize_value = { type = hit_die variable = th_danmaku_attack_roll_die_type }
		th_log_memorize_value = { type = hit_die_amount variable = th_danmaku_attack_roll_amount }
		th_log_memorize_value = { type = hit_die_result variable = th_danmaku_attack_roll }
		th_log_memorize_value = { type = enemy_ac variable = th_danmaku_enemy_armor_class_transfer }
		th_log_memorize_value = { type = hit_die_flat_bonus variable = th_danmaku_hit_bonus }
		th_log_memorize_value = { type = hit_die_bonus_per_roll variable = th_danmaku_hit_bonus_per_roll }
		if = {
			limit = {
				check_variable = {
					which = th_danmaku_attack_roll
					which = th_danmaku_enemy_armor_class_transfer
				}
			}
			set_ruler_flag = th_danmaku_duel_hit_attack
			clr_ruler_flag = th_danmaku_duel_missed_attack
			if = {
				limit = { has_ruler_flag = th_danmaku_rolled_critical_hit }
				th_play_sound = { sound = th_danmaku_duel_ability_$ability$_critical_hit }
				set_variable = {
					which = th_danmaku_crit_multiplier
					which = th_danmaku_crit_roll_damage_multiplier
				}
			}
			else = {
				th_play_sound = { sound = th_danmaku_duel_ability_$ability$_hit }
				set_variable = {
					which = th_danmaku_crit_multiplier
					which = 0
				}
			}
			th_deal_damage = yes
		}
		else = {
			clr_ruler_flag = th_danmaku_duel_hit_attack
			set_ruler_flag = th_danmaku_duel_missed_attack
			clr_ruler_flag = th_danmaku_rolled_critical_hit
			th_play_sound = { sound = th_danmaku_duel_miss }
		}
	}
}

th_deal_damage = {
	if = {
		limit = { has_saved_event_target = enemy_duelist }
		#What type of die?
		set_variable = {
			which = th_danmaku_damage_die
			which = th_danmaku_attack_die
		}
		change_variable = {
			which = th_danmaku_damage_die
			which = th_danmaku_ability_damage_die_bonus
		}
		#How many dies?
		set_variable = {
			which = th_danmaku_damage_die_amount
			value = 1
		}
		change_variable = {
			which = th_danmaku_damage_die_amount
			which = th_danmaku_ability_damage_die_amount_bonus
		}
		#Rolled damage end result
		set_variable = {
			which = th_danmaku_damage_roll
			value = 0
		}
		th_log_memorize_value = { type = attack_die variable = th_danmaku_damage_die }
		th_log_memorize_value = { type = attack_die_amount variable = th_danmaku_damage_die_amount }
		th_log_memorize_value = { type = attack_die_bonus_per_roll variable = th_danmaku_ability_damage_flat_bonus_per_die }
		th_log_memorize_value = { type = attack_die_flat_bonus variable = th_danmaku_ability_damage_flat_bonus }
		th_roll_die = {
			die_type = th_danmaku_damage_die
			die_amount = th_danmaku_damage_die_amount
			bonus_per_roll = th_danmaku_ability_damage_flat_bonus_per_die
			result = th_danmaku_damage_roll
		}
		change_variable = {
			which = th_danmaku_damage_roll
			which = th_danmaku_ability_damage_flat_bonus
		}
		th_log_memorize_value = { type = attack_die_result variable = th_danmaku_damage_roll }
		if = {
			limit = { has_ruler_flag = th_danmaku_rolled_critical_hit }
			change_variable = {
				which = th_danmaku_crit_multiplier
				value = 1
			}
			multiply_variable = {
				which = th_danmaku_damage_roll
				which = th_danmaku_crit_multiplier
			}
			th_log_memorize_value = { type = critical_damage_bonus variable = th_danmaku_crit_multiplier }
		}
		event_target:enemy_duelist = {
			set_variable = {
				which = th_danmaku_resistance_transfer
				which = th_danmaku_resistance
			}
		}
		set_variable = {
			which = th_danmaku_resistance_transfer
			which = PREV
		}
		divide_variable = {
			which = th_danmaku_resistance_transfer
			value = 100
		}
		multiply_variable = {
			which = th_danmaku_resistance_transfer
			which = th_danmaku_damage_roll
		}
		subtract_variable = {
			which = th_danmaku_damage_roll
			which = th_danmaku_resistance_transfer
		}
		th_log_memorize_value = { type = resistance_reduction variable = th_danmaku_resistance_transfer }
		if = {
			limit = { NOT = { check_variable = { which = th_danmaku_damage_roll value = 0 } } }
			set_variable = { which = th_danmaku_damage_roll value = 0 }
		}
		th_log_memorize_value = { type = total_value variable = th_danmaku_damage_roll }
		event_target:enemy_duelist = {
			set_variable = {
				which = th_danmaku_damage_roll
				which = PREV
			}
			subtract_variable = {
				which = th_danmaku_health
				which = th_danmaku_damage_roll
			}
			if = {
				limit = { NOT = { check_variable = { which = th_danmaku_health value = 0 } } }
				set_variable = {
					which = th_danmaku_health
					value = 0
				}
			}
			th_gui_update_danmaku_bar = { type = health }
			th_check_if_kill = yes
		}
		th_gui_get_enemy_resource_bar = { type = health }
	}
}

th_utilize_random_number_damage = {
	th_create_event_target_enemy_duelist = yes
	change_variable = {
		which = th_danmaku_damage_roll
		which = th_danmaku_ability_damage_flat_bonus
	}
	change_variable = {
		which = th_danmaku_crit_multiplier
		value = 1
	}
	multiply_variable = {
		which = th_danmaku_damage_roll
		which = th_danmaku_crit_multiplier
	}
	event_target:enemy_duelist = {
		set_variable = {
			which = th_danmaku_resistance_transfer
			which = th_danmaku_resistance
		}
	}
	set_variable = {
		which = th_danmaku_resistance_transfer
		which = PREV
	}
	divide_variable = {
		which = th_danmaku_resistance_transfer
		value = 100
	}
	multiply_variable = {
		which = th_danmaku_resistance_transfer
		which = th_danmaku_damage_roll
	}
	subtract_variable = {
		which = th_danmaku_damage_roll
		which = th_danmaku_resistance_transfer
	}
	if = {
		limit = { NOT = { check_variable = { which = th_danmaku_damage_roll value = 0 } } }
		set_variable = { which = th_danmaku_damage_roll value = 0 }
	}
	th_log_memorize_value = { type = total_value variable = th_danmaku_damage_roll }
	event_target:enemy_duelist = {
		set_variable = {
			which = th_danmaku_damage_roll
			which = PREV
		}
		subtract_variable = {
			which = th_danmaku_health
			which = th_danmaku_damage_roll
		}
		if = {
			limit = { NOT = { check_variable = { which = th_danmaku_health value = 0 } } }
			set_variable = {
				which = th_danmaku_health
				value = 0
			}
		}
		th_gui_update_danmaku_bar = { type = health }
		th_check_if_kill = yes
	}
	th_gui_get_enemy_resource_bar = { type = health }
	clr_country_flag = th_used_die_for_damage
}
th_utilize_random_number = {
	th_utilize_random_number_$type$ = yes
}


th_play_sound = {
	if = {
		limit = { 1 = { check_variable = { which = th_danmaku_sound_effects value = 1 } } }
		play_sound = $sound$
		if = {
			limit = {
				has_saved_event_target = enemy_duelist
				event_target:enemy_duelist = {
					has_country_flag = th_opened_danmaku_battle_window
					NOT = { tag = PREV }
				}
			}
			event_target:enemy_duelist = { play_sound = $sound$ }
		}
		if = {
			limit = {
				has_saved_event_target = root_duelist
				event_target:root_duelist = {
					has_country_flag = th_opened_danmaku_battle_window
					NOT = { tag = PREV }
				}
			}
			event_target:root_duelist = { play_sound = $sound$ }
		}
	}
}

th_use_ability = {
	hidden_effect = {
		th_create_event_target_enemy_duelist = yes
		th_play_sound = { sound = th_danmaku_duel_ability_$ability$_launch }
		#Hit bonuses
		set_variable = { which = th_danmaku_ability_hit_flat_bonus value = 0 }
		[[hit_flat_bonus]change_variable = { which = th_danmaku_ability_hit_flat_bonus value = $hit_flat_bonus$ }]
		set_variable = { which = th_danmaku_ability_hit_die_bonus value = 0 }
		[[hit_die_bonus]change_variable = { which = th_danmaku_ability_hit_die_bonus value = $hit_die_bonus$ }]

		#Damage bonuses
		set_variable = { which = th_danmaku_ability_damage_flat_bonus value = 0 }
		[[damage_flat_bonus]change_variable = { which = th_danmaku_ability_damage_flat_bonus value = $damage_flat_bonus$ }]
		set_variable = { which = th_danmaku_ability_damage_die_bonus value = 0 }
		[[damage_die_bonus]change_variable = { which = th_danmaku_ability_damage_die_bonus value = $damage_die_bonus$ }]
		set_variable = { which = th_danmaku_ability_damage_die_amount_bonus value = 0 }
		[[damage_die_amount_bonus]change_variable = { which = th_danmaku_ability_damage_die_amount_bonus value = $damage_die_amount_bonus$ }]
		set_variable = { which = th_danmaku_ability_damage_flat_bonus_per_die value = 0 }
		[[damage_flat_bonus_per_die]change_variable = { which = th_danmaku_ability_damage_flat_bonus_per_die value = $damage_flat_bonus_per_die$ }]


		th_use_ability_$ability$ = yes
	}
}



#Solo Experience
#Following Touhou characters are supported:
# reimu, marisa, mima, konngara, sariel, rika, meira, kana, kotohime, ellen, rikako, chiyuri, yumemi, kurumi, elly, 
# gengetsu, mugetsu, yuuka, alice, yuki, mai, yumeko, shinki, rumia, cirno, daiyousei, meiling, koakuma, patchouli, 
# sakuya, remilia, flandre, satsuki, letty, chen, lily, prismriver, lunasa, merlin, lyrica, layla, youmu, youki, 
# yuyuko, ran, yukari, suika, wriggle, mystia, keine, tewi, reisen, eirin, kaguya, mokou, aya, medicine, komachi, 
# eiki, shizuha, minoriko, hina, nitori, momiji, sanae, kanako, suwako, iku, tenshi, kisume, yamame, parsee, yuugi, 
# satori, orin, okuu, koishi, nazrin, kogasa, ichirin, minamitsu, shou, byakuren, nue, hatate, kyouko, yoshika, 
# seiga, tojiko, futo, miko, mamizou, kokoro, wakasagihime, sekibanki, kagerou, benben, yatsuhashi, seija, shinmyoumaru, 
# raiko, sumireko, renko, maribel, seiran, ringo, doremy, sagune, clownpiece, junko, hecatia, toyohime, yorihime, 
# change, reisen_moon, joon, shion, sunny, star, luna, kasen, larva, nemuno, aunn, narumi, teireida, satonono, okina, 
# eika, urumi, kutaka, mayumi, keiki, yachie, saki, yuuma, mike, takane, sannyo, misumaru, tsukasa, megumu, chimata, 
# momoyo, son, enoko, chiyari, hisami, zanmu, rinnosuke, tokiko, miyoi, mizuchi, zun
th_set_enemy_character_danmaku_creature_type_human = {}
th_set_enemy_character_danmaku_creature_type_fairy = {}
th_set_enemy_character_danmaku_creature_type_vampire = {}
th_set_enemy_character_danmaku_creature_type_god = {}
th_set_enemy_character_danmaku_creature_type_demigod = {}
th_set_enemy_character_danmaku_creature_type_immortal = {}
th_set_enemy_character_danmaku_creature_type_undead = {}
th_set_enemy_character_danmaku_creature_type_half_phantom = {}
th_set_enemy_character_danmaku_creature_type_half_youkai = {}
th_set_enemy_character_danmaku_creature_type_youkai = {}
th_set_enemy_character_danmaku_creature_type_yama = {}
th_set_enemy_character_danmaku_creature_type_hermit = {}
th_set_enemy_character_danmaku_creature_type_lunarian = {}
th_set_enemy_character_danmaku_creature_type_oni = {}
th_set_enemy_character_danmaku_creature_type_demon = {}
th_set_enemy_character_danmaku_creature_type_devil = {}
th_set_enemy_character_danmaku_creature_type_tengu = {}
th_set_enemy_character_danmaku_creature_type_kappa = {}
th_set_enemy_character_danmaku_creature_type_tsukumogami = {}
th_set_enemy_character_danmaku_creature_type_yamanba = {}
th_set_enemy_character_danmaku_creature_type_nue = {}
th_set_enemy_character_danmaku_creature_type_satori = {}
th_set_enemy_character_danmaku_creature_type_angel = {}
th_set_enemy_character_danmaku_creature_type_shinigami = {}
th_set_enemy_character_danmaku_creature_type_inchling = {}
th_set_enemy_character_danmaku_creature_type_doll = {}
th_set_enemy_character_danmaku_creature_type_robot = {}
th_set_enemy_character_danmaku_creature_type_celestial = {}
th_set_enemy_character_danmaku_creature_type = {
	hidden_effect = {
		set_ruler_flag = th_danmaku_enemy_danmaku_character_creature_type_$type$
	}
	th_set_enemy_character_danmaku_creature_type_$type$ = yes
}
th_set_enemy_character_danmaku_class_barbarian = {}
th_set_enemy_character_danmaku_class_warrior = {}
th_set_enemy_character_danmaku_class_rogue = {}
th_set_enemy_character_danmaku_class_ranger = {}
th_set_enemy_character_danmaku_class_bard = {}
th_set_enemy_character_danmaku_class_monk = {}
th_set_enemy_character_danmaku_class_paladin = {}
th_set_enemy_character_danmaku_class_cleric = {}
th_set_enemy_character_danmaku_class_priest = {}
th_set_enemy_character_danmaku_class_druid = {}
th_set_enemy_character_danmaku_class_sorcerer = {}
th_set_enemy_character_danmaku_class_warlock = {}
th_set_enemy_character_danmaku_class_mage = {}
th_set_enemy_character_danmaku_class_artificer = {}
th_set_enemy_character_danmaku_class_commoner = {}
th_set_enemy_character_danmaku_class = {
	hidden_effect = {
		set_ruler_flag = th_danmaku_enemy_danmaku_character_class_$class$
	}
	th_set_danmaku_class_$class$ = yes
}

th_define_enemy_danmaku_character_reimu = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = priest }
}
th_define_enemy_danmaku_character_marisa = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_mima = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_konngara = {
	th_set_enemy_character_danmaku_creature_type = { type = oni }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_sariel = {
	th_set_enemy_character_danmaku_creature_type = { type = angel }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_rika = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_meira = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_kana = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_kotohime = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_ellen = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_rikako = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_chiyuri = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_yumemi = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_kurumi = {
	th_set_enemy_character_danmaku_creature_type = { type = vampire }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_elly = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_gengetsu = {
	th_set_enemy_character_danmaku_creature_type = { type = demon }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_mugetsu = {
	th_set_enemy_character_danmaku_creature_type = { type = demon }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_yuuka = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_alice = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_yuki = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_mai = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_yumeko = {
	th_set_enemy_character_danmaku_creature_type = { type = demon }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_shinki = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_rumia = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_cirno = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_daiyousei = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_meiling = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = monk }
}
th_define_enemy_danmaku_character_koakuma = {
	th_set_enemy_character_danmaku_creature_type = { type = devil }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_patchouli = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_sakuya = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_remilia = {
	th_set_enemy_character_danmaku_creature_type = { type = vampire }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_flandre = {
	th_set_enemy_character_danmaku_creature_type = { type = vampire }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_satsuki = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = priest }
}
th_define_enemy_danmaku_character_letty = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_chen = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_lily = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_prismriver = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_lunasa = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_merlin = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_lyrica = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_layla = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_youmu = {
	th_set_enemy_character_danmaku_creature_type = { type = half_phantom }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_youki = {
	th_set_enemy_character_danmaku_creature_type = { type = half_phantom }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_yuyuko = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_ran = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_yukari = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_suika = {
	th_set_enemy_character_danmaku_creature_type = { type = oni }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_wriggle = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_mystia = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_keine = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_tewi = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_reisen = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_eirin = {
	th_set_enemy_character_danmaku_creature_type = { type = lunarian }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_kaguya = {
	th_set_enemy_character_danmaku_creature_type = { type = immortal }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_mokou = {
	th_set_enemy_character_danmaku_creature_type = { type = immortal }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_aya = {
	th_set_enemy_character_danmaku_creature_type = { type = tengu }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_medicine = {
	th_set_enemy_character_danmaku_creature_type = { type = doll }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_komachi = {
	th_set_enemy_character_danmaku_creature_type = { type = shinigami }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_eiki = {
	th_set_enemy_character_danmaku_creature_type = { type = yama }
	th_set_enemy_character_danmaku_class = { class = paladin }
}
th_define_enemy_danmaku_character_shizuha = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_minoriko = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_hina = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_nitori = {
	th_set_enemy_character_danmaku_creature_type = { type = kappa }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_momiji = {
	th_set_enemy_character_danmaku_creature_type = { type = tengu }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_sanae = {
	th_set_enemy_character_danmaku_creature_type = { type = demigod }
	th_set_enemy_character_danmaku_class = { class = priest }
}
th_define_enemy_danmaku_character_kanako = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_suwako = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_iku = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_tenshi = {
	th_set_enemy_character_danmaku_creature_type = { type = celestial }
	th_set_enemy_character_danmaku_class = { class = paladin }
}
th_define_enemy_danmaku_character_kisume = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_yamame = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_parsee = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_yuugi = {
	th_set_enemy_character_danmaku_creature_type = { type = oni }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_satori = {
	th_set_enemy_character_danmaku_creature_type = { type = satori }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_orin = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_okuu = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_koishi = {
	th_set_enemy_character_danmaku_creature_type = { type = satori }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_nazrin = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_kogasa = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_ichirin = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_minamitsu = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_shou = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_byakuren = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = monk }
}
th_define_enemy_danmaku_character_nue = {
	th_set_enemy_character_danmaku_creature_type = { type = nue }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_hatate = {
	th_set_enemy_character_danmaku_creature_type = { type = tengu }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_kyouko = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_yoshika = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_seiga = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_tojiko = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_futo = {
	th_set_enemy_character_danmaku_creature_type = { type = hermit }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_miko = {
	th_set_enemy_character_danmaku_creature_type = { type = hermit }
	th_set_enemy_character_danmaku_class = { class = paladin }
}
th_define_enemy_danmaku_character_mamizou = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_kokoro = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_wakasagihime = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_sekibanki = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_kagerou = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_benben = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_yatsuhashi = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_seija = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_shinmyoumaru = {
	th_set_enemy_character_danmaku_creature_type = { type = inchling }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_raiko = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_sumireko = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_renko = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_maribel = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_seiran = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_ringo = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_doremy = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_sagune = {
	th_set_enemy_character_danmaku_creature_type = { type = lunarian }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_clownpiece = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_junko = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_hecatia = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_toyohime = {
	th_set_enemy_character_danmaku_creature_type = { type = lunarian }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_yorihime = {
	th_set_enemy_character_danmaku_creature_type = { type = lunarian }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_change = {
	th_set_enemy_character_danmaku_creature_type = { type = lunarian }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_reisen_moon = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_joon = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_shion = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_sunny = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_star = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_luna = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_kasen = {
	th_set_enemy_character_danmaku_creature_type = { type = oni }
	th_set_enemy_character_danmaku_class = { class = monk }
}
th_define_enemy_danmaku_character_larva = {
	th_set_enemy_character_danmaku_creature_type = { type = fairy }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_nemuno = {
	th_set_enemy_character_danmaku_creature_type = { type = yamanba }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_aunn = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_narumi = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = mage }
}
th_define_enemy_danmaku_character_teireida = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_satonono = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_okina = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_eika = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_urumi = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_kutaka = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = druid }
}
th_define_enemy_danmaku_character_mayumi = {
	th_set_enemy_character_danmaku_creature_type = { type = tsukumogami }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_keiki = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = cleric }
}
th_define_enemy_danmaku_character_yachie = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_saki = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_yuuma = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_mike = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_takane = {
	th_set_enemy_character_danmaku_creature_type = { type = kappa }
	th_set_enemy_character_danmaku_class = { class = artificer }
}
th_define_enemy_danmaku_character_sannyo = {
	th_set_enemy_character_danmaku_creature_type = { type = yamanba }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_misumaru = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = sorcerer }
}
th_define_enemy_danmaku_character_tsukasa = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_megumu = {
	th_set_enemy_character_danmaku_creature_type = { type = tengu }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_chimata = {
	th_set_enemy_character_danmaku_creature_type = { type = god }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_momoyo = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_son = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = monk }
}
th_define_enemy_danmaku_character_enoko = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = ranger }
}
th_define_enemy_danmaku_character_chiyari = {
	th_set_enemy_character_danmaku_creature_type = { type = demon }
	th_set_enemy_character_danmaku_class = { class = rogue }
}
th_define_enemy_danmaku_character_hisami = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_zanmu = {
	th_set_enemy_character_danmaku_creature_type = { type = oni }
	th_set_enemy_character_danmaku_class = { class = barbarian }
}
th_define_enemy_danmaku_character_rinnosuke = {
	th_set_enemy_character_danmaku_creature_type = { type = half_youkai }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_tokiko = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = warrior }
}
th_define_enemy_danmaku_character_miyoi = {
	th_set_enemy_character_danmaku_creature_type = { type = youkai }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character_mizuchi = {
	th_set_enemy_character_danmaku_creature_type = { type = undead }
	th_set_enemy_character_danmaku_class = { class = warlock }
}
th_define_enemy_danmaku_character_zun = {
	th_set_enemy_character_danmaku_creature_type = { type = human }
	th_set_enemy_character_danmaku_class = { class = bard }
}
th_define_enemy_danmaku_character = {

}

th_create_danmaku_duel_against_unlanded_character = {
	custom_tooltip = th_create_danmaku_duel_against_unlanded_character_$target$_tt
	hidden_effect = {
		th_prepare_country_for_danmaku_duel = yes
		set_ruler_flag = th_is_duelling_an_unlanded_character
		set_ruler_flag = th_is_duelling_character_$target$
		th_roll_initiative_for_solo_fight = yes
		set_variable = {
			which = th_danmaku_unlanded_duel_round_counter
			value = 1
		}
		set_variable = {
			which = th_danmaku_unlanded_duel_opponent_turn
			value = 0
		}
		set_variable = {
			which = th_danmaku_unlanded_turn_duration
			value = 18
		}
		set_variable = {
			which = th_danmaku_unlanded_turn_duration_alert
			value = 6
		}
		1 = {
			set_variable = {
				which = th_danmaku_default_turn_duration_transfer
				which = th_dnamaku_default_turn_duration
			}
			PREV = {
				set_variable = { which = th_danmaku_default_turn_duration_transfer 		which = PREV }
				set_variable = {
					which = th_danmaku_unlanded_turn_duration
					which = th_danmaku_default_turn_duration_transfer
				}
			}
		}
	}
}

th_roll_initiative_for_solo_fight = {
	custom_tooltip = th_roll_initiative_for_solo_fight_tt
	hidden_effect = {
		th_roll_initiative = yes
		th_alternative_roll_initiative = {
			variable = th_danmaku_unlanded_character_rolled_initiative
			bonus = th_danmaku_unlanded_character_ini_bonus
		}
		if = {
			limit = {
				check_variable = {
					which = th_danmaku_rolled_initiative
					which = th_danmaku_unlanded_character_rolled_initiative
				}
			}
			set_ruler_flag = th_danmaku_has_turn_ownership
			set_ruler_flag = th_danmaku_unlanded_character_not_turn_ownership
			th_on_new_own_turn = yes
		}
		else = {
			set_ruler_flag = th_danmaku_unlanded_character_turn_ownership
			set_ruler_flag = th_danmaku_has_not_turn_ownership
			th_on_new_enemy_turn = yes
		}
	}
}

th_end_turn_against_unlanded_character = {
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = th_danmaku_unlanded_duel_opponent_turn
					value = 1
				}
			}
		}
		set_variable = {
			which = th_danmaku_unlanded_duel_opponent_turn
			value = 1
		}
		if = {
			limit = {
				has_ruler_flag = th_danmaku_has_turn_ownership
			}
			clr_ruler_flag = th_danmaku_has_turn_ownership
			clr_ruler_flag = th_danmaku_unlanded_character_not_turn_ownership
			set_ruler_flag = th_danmaku_unlanded_character_turn_ownership
			set_ruler_flag = th_danmaku_has_not_turn_ownership
			th_on_new_enemy_turn = yes
		}
		else = {
			set_ruler_flag = th_danmaku_has_turn_ownership
			th_on_new_own_turn = yes
			set_ruler_flag = th_danmaku_unlanded_character_not_turn_ownership
			clr_ruler_flag = th_danmaku_unlanded_character_turn_ownership
			clr_ruler_flag = th_danmaku_has_not_turn_ownership
		}
	}
	else = {
		set_variable = {
			which = th_danmaku_unlanded_duel_opponent_turn
			value = 0
		}
		change_variable = {
			which = th_danmaku_unlanded_duel_round_counter
			value = 1
		}
		th_roll_initiative_for_solo_fight = yes
	}
	1 = {
		set_variable = {
			which = th_danmaku_default_turn_duration_transfer
			which = th_dnamaku_default_turn_duration
		}
		PREV = {
			set_variable = { which = th_danmaku_default_turn_duration_transfer 		which = PREV }
			set_variable = {
				which = th_danmaku_unlanded_turn_duration
				which = th_danmaku_default_turn_duration_transfer
			}
		}
	}
}