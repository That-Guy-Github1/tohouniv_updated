########################################
# Danmaku Events
########################################

namespace = th_danmaku_duel_event
#Victory
country_event = {
	id = th_danmaku_duel_event.1
	title = th_danmaku_duel_event.1.title
	desc = th_danmaku_duel_event.1.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			th_create_event_target_enemy_duelist = yes
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = win }
			th_define_danmaku_gold_reward = yes
			th_define_danmaku_power_reward = yes
		}
	}
	option = {
		name = th_danmaku_duel_event.1.a
		th_add_danmaku_exp_reward = { type = victory }
		th_add_danmaku_gold_reward = { type = victory }
		th_add_danmaku_power_reward = { type = victory }
		add_power_projection = {
			type = th_won_danmaku_duel_power_projection
			amount = 5
		}
	}
	after = {
		th_deactivate_current_instance = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = victory }
	}
}
#Defeat
country_event = {
	id = th_danmaku_duel_event.2
	title = th_danmaku_duel_event.2.title
	desc = th_danmaku_duel_event.2.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			th_create_event_target_enemy_duelist = yes
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = base }
		}
	}
	option = {
		name = th_danmaku_duel_event.2.a
		th_danmaku_lose_effect = yes
		add_power_projection = {
			type = th_lost_danmaku_duel_power_projection
			amount = -5
		}
	}
	after = {
		th_deactivate_current_instance = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = defeat }
	}
}
#Draw
country_event = {
	id = th_danmaku_duel_event.3
	title = th_danmaku_duel_event.3.title
	desc = th_danmaku_duel_event.3.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			th_create_event_target_enemy_duelist = yes
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = base }
			th_define_danmaku_gold_reward = yes
			th_define_danmaku_power_reward = yes
			th_reward_multiplier = {
				type = gold
				factor = 0.5
			}
			th_reward_multiplier = {
				type = power
				factor = 0.5
			}
		}
	}
	option = {
		name = th_danmaku_duel_event.3.a
		th_add_danmaku_exp_reward = { type = draw }
		th_add_danmaku_gold_reward = { type = draw }
		th_add_danmaku_power_reward = { type = draw }
	}
	after = {
		th_deactivate_current_instance = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = draw }
	}
}
#Ruler dies mid-combat
country_event = {
	id = th_danmaku_duel_event.4
	title = th_danmaku_duel_event.4.title
	desc = th_danmaku_duel_event.4.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	trigger = {
		has_country_flag = th_is_in_a_danmaku_duel
		NOT = { has_ruler_flag = th_ruler_is_in_a_danmaku_duel }
	}
	immediate = {
		hidden_effect = {
			th_create_event_target_enemy_duelist = yes
			set_country_flag = th_danmaku_locked_actions
		}
	}
	option = {
		name = th_danmaku_duel_event.4.a
		if = {
			limit = { has_saved_event_target = enemy_duelist }
			event_target:enemy_duelist = {
				country_event = {
					id = th_danmaku_duel_event.5
				}
			}
		}
	}
	after = {
		th_deactivate_current_instance = yes
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = defeat }
	}
}
#Enemy dies mid-combat
country_event = {
	id = th_danmaku_duel_event.5
	title = th_danmaku_duel_event.5.title
	desc = th_danmaku_duel_event.5.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			set_country_flag = th_danmaku_locked_actions
		}
	}
	option = {
		name = th_danmaku_duel_event.5.a
	}
	after = {
		th_deactivate_current_instance = yes
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = victory }
	}
}
#Enemy country gets annexed
country_event = {
	id = th_danmaku_duel_event.6
	title = th_danmaku_duel_event.6.title
	desc = th_danmaku_duel_event.6.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			set_country_flag = th_danmaku_locked_actions
		}
	}
	option = {
		name = th_danmaku_duel_event.6.a
	}
	after = {
		th_deactivate_current_instance = yes
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = victory }
	}
}

#SOLO
#Victory
country_event = {
	id = th_danmaku_duel_event.7
	title = th_danmaku_duel_event.7.title
	desc = th_danmaku_duel_event.7.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = win }
			th_define_danmaku_gold_reward = yes
			th_define_danmaku_power_reward = yes
		}
	}
	option = {
		name = th_danmaku_duel_event.7.a
		th_add_danmaku_exp_reward = { type = victory }
		th_add_danmaku_gold_reward = { type = victory }
		th_add_danmaku_power_reward = { type = victory }
		add_power_projection = {
			type = th_won_danmaku_duel_power_projection
			amount = 5
		}
	}
	after = {
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = victory }
	}
}
#Defeat
country_event = {
	id = th_danmaku_duel_event.8
	title = th_danmaku_duel_event.8.title
	desc = th_danmaku_duel_event.8.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = base }
		}
	}
	option = {
		name = th_danmaku_duel_event.8.a
		th_danmaku_lose_effect = yes
		add_power_projection = {
			type = th_lost_danmaku_duel_power_projection
			amount = -5
		}
	}
	after = {
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = defeat }
	}
}
#Draw
country_event = {
	id = th_danmaku_duel_event.9
	title = th_danmaku_duel_event.9.title
	desc = th_danmaku_duel_event.9.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			set_country_flag = th_danmaku_locked_actions
			th_define_exp_reward = { type = base }
			th_define_danmaku_gold_reward = yes
			th_define_danmaku_power_reward = yes
			th_reward_multiplier = {
				type = gold
				factor = 0.5
			}
			th_reward_multiplier = {
				type = power
				factor = 0.5
			}
		}
	}
	option = {
		name = th_danmaku_duel_event.9.a
		th_add_danmaku_exp_reward = { type = draw }
		th_add_danmaku_gold_reward = { type = draw }
		th_add_danmaku_power_reward = { type = draw }
	}
	after = {
		th_clear_combat = yes
		clr_country_flag = th_danmaku_locked_actions
		clr_country_flag = th_opened_danmaku_battle_window
		th_post_danmaku_trigger_events = { type = draw }
	}
}

#Explanation Events
country_event = {
	id = th_danmaku_duel_event.10
	title = th_danmaku_duel_event.10.title
	desc = th_danmaku_duel_event.10.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	option = {
		name = th_danmaku_duel_event.10.a
	}
}

#Information Events
# [FROM] challenges [ROOT]!
country_event = {
	id = th_danmaku_duel_event.20
	title = th_danmaku_duel_event.20.title
	desc = th_danmaku_duel_event.20.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	#Oh great...
	option = {
		name = th_danmaku_duel_event.20.a
	}
	#To battle!
	option = {
		name = th_danmaku_duel_event.20.b
		custom_tooltip = th_danmaku_duel_event.20.b.tt
		set_country_flag = th_opened_danmaku_battle_window
	}
	#A what?
	option = {
		name = th_danmaku_duel_event.20.c
		country_event = {
			id = th_danmaku_duel_event.10
		}
	}
}
# A Danmaku Challenge appears!
country_event = {
	id = th_danmaku_duel_event.21
	title = th_danmaku_duel_event.21.title
	desc = th_danmaku_duel_event.21.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	#Oh great...
	option = {
		name = th_danmaku_duel_event.20.a
	}
	#To battle!
	option = {
		name = th_danmaku_duel_event.20.b
		custom_tooltip = th_danmaku_duel_event.20.b.tt
		set_country_flag = th_opened_danmaku_battle_window
	}
	#A what?
	option = {
		name = th_danmaku_duel_event.20.c
		country_event = {
			id = th_danmaku_duel_event.10
		}
	}
}

#Monthly GLOBAL Update
country_event = {
	id = th_danmaku_duel_event.100
	title = th_danmaku_duel_event.100.t
	desc = th_danmaku_duel_event.100.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	mean_time_to_happen = {
		days = 1
	}
	trigger = {
		owns = 1
		OR = {
			had_global_flag = {
				flag = th_danmaku_monthly_update
				days = 30
			}
			NOT = { has_global_flag = th_danmaku_monthly_update }
		}
	}
	hidden = yes
	option = {
		name = th_danmaku_duel_event.100.a
		clr_global_flag = th_danmaku_monthly_update
		set_global_flag = th_danmaku_monthly_update
		th_monthly_danmaku_duel_update = yes
		ai_chance = {
			factor = 1
		}
	}
}

#Monthly COUNTRY Update
country_event = {
	id = th_danmaku_duel_event.101
	title = th_danmaku_duel_event.101.t
	desc = th_danmaku_duel_event.101.desc
	picture = SPELLCARD_eventPicture
	is_triggered_only = yes
	mean_time_to_happen = {
		days = 1
	}
	trigger = {
		th_has_danmaku_duels_unlocked = yes
	}
	hidden = yes
	option = {
		name = th_danmaku_duel_event.101.a
		th_monthly_country_danmaku_duel_update = yes
		ai_chance = {
			factor = 1
		}
	}
}

#Setup stats
country_event = {
	id = th_danmaku_duel_event.1000
	title = th_danmaku_duel_event.1000.t
	desc = th_danmaku_duel_event.1000.desc
	picture = TANYA_eventPicture
	is_triggered_only = yes
	hidden = yes
	trigger = {
		NOT = { has_country_flag = th_danmaku_setup_event }
		th_has_danmaku_duels_unlocked = yes
		has_regency = no
		is_lesser_in_union = no
		NOT = { has_ruler_flag = th_danmaku_ruler_is_set }
	}
	immediate = {
		th_set_dynamically_danmaku_ruler = yes
	}
	option = {
		name = th_danmaku_duel_event.1000.a
		set_country_flag = th_danmaku_setup_event
		th_set_default_danmaku_stats = yes
		th_refresh_class_and_species_stats = yes
		ai_chance = {
			factor = 1
		}
	}
}



namespace = th_danmaku_duel_ai
#Initial mtth event which creates the AI behavior
country_event = {
	id = th_danmaku_duel_ai.1
	title = none
	desc = none
	picture = TANYA_eventPicture
	trigger = {
		th_is_in_a_danmaku_duel = yes
		NOT = { has_country_flag = th_danmaku_ai_started_turn }
		OR = {
			AND = {
				th_has_turn_ownership = yes
				ai = yes
			}
			AND = {
				th_is_duelling_an_unlanded_character = yes
				th_unlanded_character_has_turn_ownership = yes
			}
		}
	}
	hidden = yes
	#major = yes
	mean_time_to_happen = {
		days = 1
	}
	immediate = {
		set_country_flag = th_danmaku_ai_started_turn
	}
	option = {
		country_event = {
			id = th_danmaku_duel_ai.2
			days = 1
		}
		ai_chance = {
			factor = 100
		}
	}
}
#Re-compute
country_event = {
	id = th_danmaku_duel_ai.2
	title = none
	desc = none
	picture = TANYA_eventPicture
	is_triggered_only = yes
	hidden = yes
	option = {
		country_event = {
			id = th_danmaku_duel_ai.3
		}
		ai_chance = {
			factor = 100
		}
	}
}
#Triggered event
country_event = {
	id = th_danmaku_duel_ai.3
	title = none
	desc = none
	picture = TANYA_eventPicture
	is_triggered_only = yes
	hidden = yes
	#major = yes
	#Magic Bolt option
	option = {
		trigger = {
			OR = {
				AND = {
					th_is_duelling_an_unlanded_character = yes
					th_unlanded_character_has_turn_ownership = yes
					th_is_alive_solo = yes
					th_ai_can_use_ability = { ability = magic_bolt }
				}
				AND = {
					th_is_not_duelling_an_unlanded_character = yes
					th_has_turn_ownership = yes
					th_is_alive = yes
					th_can_use_ability = { ability = magic_bolt }
				}
			}
		}
		th_use_ability = {
			ability = magic_bolt
		}
		country_event = {
			id = th_danmaku_duel_ai.2
			days = 1
		}
		ai_chance = {
			factor = 100
		}
	}
	#Attack option
	option = {
		trigger = {
			OR = {
				AND = {
					th_is_duelling_an_unlanded_character = yes
					th_unlanded_character_has_turn_ownership = yes
					th_is_alive_solo = yes
					th_ai_can_use_ability = { ability = attack }
				}
				AND = {
					th_is_not_duelling_an_unlanded_character = yes
					th_has_turn_ownership = yes
					th_is_alive = yes
					th_can_use_ability = { ability = attack }
				}
			}
		}
		th_use_ability = {
			ability = attack
		}
		country_event = {
			id = th_danmaku_duel_ai.2
			days = 1
		}
		ai_chance = {
			factor = 10
		}
	}
	#The "Nah, I'd skip" option
	option = {
		trigger = {
			NOT = { th_ai_can_use_any_ability = yes }
		}
		if = {
			limit = {
				th_is_in_a_danmaku_duel = yes
				NOT = { has_ruler_flag = th_danmaku_duel_over }
			}
			th_end_turn = yes
		}
		clr_country_flag = th_danmaku_ai_started_turn
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				th_ai_can_use_any_ability = yes
			}
		}
	}
}