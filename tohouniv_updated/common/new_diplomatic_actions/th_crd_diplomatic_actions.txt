###CRD MIND READIN ABILITIES###

#CRD awakens trauma of target -> give a debuff to the target + Reveal all target's movements
th_awaken_trauma = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		has_government_attribute = enables_satori_mind_manipulation
		FROM = { is_free_or_tributary_trigger = yes }
	}

	is_allowed = {
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			has_spy_network_in = {
				who = FROM
				value = 25
			}
		}
		else = {
			has_spy_network_in = {
				who = FROM
				value = 50
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_awaken_trauma_cd_tt
			FROM = {
				OR = {
					NOT = { has_country_flag = th_awoken_traumas_by_@ROOT }
					had_country_flag = {
						flag = th_awoken_traumas_by_@ROOT
						days = 5475
					}
				}
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		FROM = {
			clr_country_flag = th_awoken_traumas_by_@ROOT
			country_event = {
				id = th_diplo_events.45
			}
            set_country_flag = th_received_trauma_by_@ROOT
		}
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			add_spy_network_in = {
				who = FROM
				value = -25
			}
		}
		else = {
			add_spy_network_in = {
				who = FROM
				value = -50
			}
		}
	}

	ai_will_do = {
		always = no
	}
}

#CRD recollect memory -> copies a special diplomatic move or mechanic for a one time use of the target
th_recollect_memory = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		has_government_attribute = enables_satori_mind_manipulation
		FROM = { is_free_or_tributary_trigger = yes }
		th_target_is_interesting_to_copy_off = {
			target = FROM
		}
	}

	is_allowed = {
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			has_spy_network_in = {
				who = FROM
				value = 25
			}
		}
		else = {
			has_spy_network_in = {
				who = FROM
				value = 50
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		th_copy_ability_from_target = {
			target = FROM
			duration = 1825
		}
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			add_spy_network_in = {
				who = FROM
				value = -25
			}
		}
		else = {
			add_spy_network_in = {
				who = FROM
				value = -50
			}
		}
		FROM = {
            set_country_flag = th_recollected_memories_by_@ROOT
		}
	}

	ai_will_do = {
		always = no
	}
}

#CRD recollect memory -> copies a special diplomatic move or mechanic for a one time use of the target (Subjects don't need to be spied on for this)
th_recollect_memory_subject = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		FROM = { is_subject_other_than_tributary_trigger = yes is_subject_of = ROOT }
		has_government_attribute = enables_satori_mind_manipulation
		th_target_is_interesting_to_copy_off = {
			target = FROM
		}
	}

	is_allowed = {
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		th_copy_ability_from_target = {
			target = FROM
			duration = 1825
		}
		FROM = {
            set_country_flag = th_recollected_memories_by_@ROOT
		}
	}

	ai_will_do = {
		always = no
	}
}

#CRD cause amnesia -> target loses all AE opinion of root
th_cause_amnesia = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		has_government_attribute = enables_satori_mind_manipulation
		FROM = { is_free_or_tributary_trigger = yes }
	}

	is_allowed = {
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			has_spy_network_in = {
				who = FROM
				value = 25
			}
		}
		else = {
			has_spy_network_in = {
				who = FROM
				value = 50
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_cause_amnesia_cd_tt
			FROM = {
				OR = {
					NOT = { has_country_flag = th_amnesia_by_@ROOT }
					had_country_flag = {
						flag = th_amnesia_by_@ROOT
						days = 5475
					}
				}
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_has_aggressive_expansion_modifier
			FROM = {
				has_opinion_modifier = {
					who = ROOT
					modifier = aggressive_expansion
				}
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		FROM = {
			remove_opinion = {
				who = ROOT
				modifier = aggressive_expansion
			}
            set_country_flag = th_received_amnesia_by_@ROOT
		}
		if = {
			limit = {
				has_country_flag = th_upgraded_satori_abilities
			}
			add_spy_network_in = {
				who = FROM
				value = -25
			}
		}
		else = {
			add_spy_network_in = {
				who = FROM
				value = -50
			}
		}
	}

	ai_will_do = {
		always = no
	}
}

###CRD SATORI VASSALS INTERACTIONS###
#CRD manipulates targets mind to become Satori vassal
th_read_the_mind = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		has_government_attribute = enables_satori_subject_interactions
		FROM = { is_free_or_tributary_trigger = yes }
	}

	is_allowed = {
		has_spy_network_in = {
			who = FROM
			value = 60
		}
		custom_trigger_tooltip = {
			tooltip = th_from_cant_be_rival_or_enemy_tt
			FROM = {
				NOT = { is_rival = ROOT }
				NOT = { is_enemy = ROOT }
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_from_is_not_in_war_tt
			FROM = {
				is_at_war = no
			}
		}
		if = {
			limit = {
				NOT = { has_country_flag = th_upgraded_satori_abilities }
			}
			custom_trigger_tooltip = {
				tooltip = th_has_not_100_dev_tt
				FROM = {
					NOT = { total_development = 100 }
				}
			}
		}
		else = {
			custom_trigger_tooltip = {
				tooltip = th_has_not_200_dev_tt
				FROM = {
					NOT = { total_development = 200 }
				}
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_needs_at_least_25_opinion_tt
			FROM = {
				has_opinion = { who = ROOT value = 25 }
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_is_not_in_coalition_against_us_tt
			FROM = {
				is_in_coalition = no 
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_is_not_outraged_about_us_tt
			FROM = {
				NOT = {
					ai_attitude = {
						who = ROOT
						attitude = attitude_outraged
					}
				}
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		add_spy_network_in = {
			who = FROM
			value = -60
		}
		FROM = {
			set_variable = {
				which = th_spy_progress
				value = 0
			}
		}
		while = {
			limit = {
				has_spy_network_in = {
					who = FROM
					value = 5
				}
			}
			add_spy_network_in = {
				who = FROM
				value = -5
			}
			FROM = {
				change_variable = {
					which = th_spy_progress
					value = 1
				}
			}
		}
		FROM = {
			country_event = {
				id = th_diplo_events.41
			}
		}
	}

	ai_will_do = {
		always = no
	}
}

#CRD suppresses free will -> usabale against subject, reduce their liberty desire for a short term at the cost of diplo power and the longterm lib desire
th_suppress_free_will = {
	category = th_diplo_action
	require_acceptance = no

	is_visible = {
		OR = {
			th_has_copied_from_target = {
				target = CRD
			}
			AND = {
				has_government_attribute = enables_satori_subject_interactions
				FROM = {
					is_subject_of = ROOT
					is_subject_of_type = th_satori_vassal
				}
			}
		}
	}

	is_allowed = {
		if = {
			limit = {
				NOT = { has_country_flag = th_upgraded_satori_abilities }
			}
			dip_power = 75
		}
		custom_trigger_tooltip = {
			tooltip = th_suppress_free_will_cd_tt
			FROM = {
				OR = {
					NOT = { has_country_flag = th_satoris_command_flag_by_@ROOT }
					had_country_flag = {
						flag = th_satoris_command_flag_by_@ROOT
						days = 5475
					}
				}
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						has_country_flag = th_immunity_to_diplomatic_actions
						has_government_attribute = enables_yama_authority
					}
				}
			}
			custom_trigger_tooltip = {
				tooltip = th_from_is_not_immune_to_diplomatic_actions_tt
				FROM = {
					NOT = { has_country_flag = th_immunity_to_diplomatic_actions }
					NOT = { has_government_attribute = enables_yama_authority }
				}
			}
		}
	}

	on_accept = {
		th_clear_copy_flag = yes
		if = {
			limit = {
				NOT = { has_country_flag = th_upgraded_satori_abilities }
			}
			add_dip_power = -75
		}
		FROM = {
			clr_country_flag = th_satoris_command_flag_by_@ROOT
			add_country_modifier = {
				name = th_satoris_command
				duration = 1825
			}
			set_country_flag = th_satoris_command_flag_by_@ROOT
		}
	}

	ai_will_do = {
		always = no
	}
}